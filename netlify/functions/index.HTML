<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>纺织厂报工系统</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
  <style>
    /* 您的所有 CSS 样式代码都保持不变 */
    :root {
      --primary: #2c6fbb;
      --secondary: #6c757d;
      --light: #f8f9fa;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --info: #17a2b8;
    }
    body {
      background-color: #f5f7fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.08);
      padding: 20px;
    }
    .header {
      text-align: center;
      padding: 15px 0;
      margin-bottom: 25px;
      border-bottom: 1px solid #eaeaea;
      position: relative;
    }
    .header h3 {
      color: var(--primary);
      font-weight: 700;
      margin: 0;
    }
    .header::after {
      content: '';
      display: block;
      width: 80px;
      height: 4px;
      background: var(--primary);
      border-radius: 2px;
      position: absolute;
      bottom: -2px;
      left: 50%;
      transform: translateX(-50%);
    }
    .nav-tabs {
      border-bottom: 2px solid #eaeaea;
      margin-bottom: 20px;
    }
    .nav-tabs .nav-link {
      font-weight: 600;
      padding: 12px 25px;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s ease;
    }
    .nav-tabs .nav-link.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 8px rgba(44, 111, 187, 0.2);
    }
    .tab-content {
      padding: 25px;
      border: 1px solid #eaeaea;
      border-radius: 0 8px 8px 8px;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    .worker-info {
      margin-bottom: 15px;
      border-radius: 8px;
    }
    .stat-card {
      text-align: center;
      padding: 20px;
      border-radius: 12px;
      background: white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s;
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }
    .stat-card i {
      font-size: 2.5rem;
      margin-bottom: 15px;
      color: var(--primary);
    }
    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
    }
    .chart-container {
      height: 300px;
      margin-top: 20px;
    }
    .match-result {
      max-height: 300px;
      overflow-y: auto;
    }
    .login-card {
      max-width: 500px;
      margin: 0 auto;
    }
    .display-column {
      background-color: #fff8e1;
      font-weight: 600;
    }
    .deleted-worker {
      background-color: #fff8f0;
      color: #ff6b6b;
    }
    .deleted-worker td:last-child {
      color: #ff6b6b;
      font-style: italic;
    }
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    .action-buttons .btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
    }
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding: 10px 0;
      border-top: 1px solid #eee;
    }
    .page-info {
      font-size: 0.9rem;
      color: #666;
    }
    .pagination-buttons {
      display: flex;
      gap: 5px;
    }
    /* 模糊匹配样式 */
    .suggestion-highlight {
      color: var(--primary);
      font-weight: bold;
      background-color: rgba(44, 111, 187, 0.1);
    }
    /* 测试数据样式 */
    .test-data-card {
      border-left: 4px solid #6f42c1;
    }
    .test-data-progress {
      height: 10px;
    }
    .test-data-status {
      font-size: 0.9rem;
    }
    /* 员工管理卡片样式 */
    .worker-card {
      border-top: 3px solid var(--primary);
    }
    .worker-card-header {
      background-color: var(--primary);
      color: white;
      border-radius: 8px 8px 0 0 !important;
    }
    .worker-stat {
      background-color: #e8f4ff;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
      transition: transform 0.3s;
    }
    .worker-stat:hover {
      transform: scale(1.03);
    }
    .worker-stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary);
    }
    .worker-stat-label {
      font-size: 0.9rem;
      color: #6c757d;
    }
    /* 新增样式 */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1050;
    }
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }
    .btn-hover-grow {
      transition: transform 0.2s ease;
    }
    .btn-hover-grow:hover {
      transform: scale(1.05);
    }
    .input-group-text {
      background-color: #e9ecef;
      transition: background-color 0.3s;
    }
    .input-group:focus-within .input-group-text {
      background-color: #dde7f5;
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.2rem rgba(44, 111, 187, 0.25);
    }
    .alert-floating {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      min-width: 300px;
      opacity: 0.95;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: fadeIn 0.3s, fadeOut 0.5s 2.5s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 0.95; transform: translateY(0); }
    }
    @keyframes fadeOut {
      from { opacity: 0.95; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-20px); }
    }
    .card-header {
      font-weight: 600;
    }
    .table-hover tbody tr {
      transition: background-color 0.2s;
    }
    .table-hover tbody tr:hover {
      background-color: rgba(44, 111, 187, 0.05);
    }
    .badge-pill {
      padding: 0.5em 0.8em;
      border-radius: 10rem;
    }
    .progress-bar-striped {
      background-image: linear-gradient(
        45deg,
        rgba(255, 255, 255, 0.15) 25%,
        transparent 25%,
        transparent 50%,
        rgba(255, 255, 255, 0.15) 50%,
        rgba(255, 255, 255, 0.15) 75%,
        transparent 75%,
        transparent
      );
      background-size: 1rem 1rem;
    }
    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
    }
    .btn-primary:hover {
      background-color: #235a9e;
      border-color: #215397;
    }
    .btn-outline-primary {
      color: var(--primary);
      border-color: var(--primary);
    }
    .btn-outline-primary:hover {
      background-color: var(--primary);
      color: white;
    }
    .btn-success {
      background-color: var(--success);
      border-color: var(--success);
    }
    .btn-info {
      background-color: var(--info);
      border-color: var(--info);
    }
    .btn-warning {
      background-color: var(--warning);
      border-color: var(--warning);
      color: #212529;
    }
    .btn-danger {
      background-color: var(--danger);
      border-color: var(--danger);
    }
    .form-label {
      font-weight: 500;
    }
    .card {
      border: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .card:hover {
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }
    .nav-link {
      position: relative;
      overflow: hidden;
    }
    .nav-link::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background-color: var(--primary);
      transform: scaleX(0);
      transform-origin: right;
      transition: transform 0.3s ease;
    }
    .nav-link.active::after,
    .nav-link:hover::after {
      transform: scaleX(1);
      transform-origin: left;
    }
    .dropdown-menu {
      max-height: 300px;
      overflow-y: auto;
    }
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 15px;
      }
      .nav-tabs .nav-link {
        padding: 8px 15px;
        font-size: 0.9rem;
      }
      .tab-content {
        padding: 15px;
      }
      .pagination-container {
        flex-direction: column;
        gap: 10px;
      }
      .action-buttons {
        flex-direction: column;
        gap: 5px;
      }
      .row > * {
        margin-bottom: 15px;
      }
    }
    /* 设备管理模块样式 */
    .machine-card {
      border-top: 3px solid var(--primary);
    }
    .machine-card-header {
      background-color: var(--primary);
      color: white;
      border-radius: 8px 8px 0 0 !important;
    }
    .machine-stat {
      background-color: #e8f4ff;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
      transition: transform 0.3s;
    }
    .machine-stat:hover {
      transform: scale(1.03);
    }
    .machine-stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary);
    }
    .machine-stat-label {
      font-size: 0.9rem;
      color: #6c757d;
    }
    /* 设备选择弹窗样式 - 更新为网格布局 */

    .machine-search-container {
        position: relative;
        margin-bottom: 1rem;
    }
    .machine-search-container .form-control {
        padding-left: 2.5rem; /* 为图标留出空间 */
    }
    .machine-search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }
    .machine-modal-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
    }
    .machine-modal-count {
        font-size: 0.875rem;
        color: #6c757d;
    }
    .machine-modal-buttons {
        display: flex;
        gap: 0.5rem;
    }
    
    /* --- 1. 增大弹窗宽度以适应10列 --- */
/* 针对超大屏幕 (通常 >= 1200px) */
@media (min-width: 1200px) {
  /* 增大 modal-xl 的最大宽度 */
  .modal-xl {
    max-width: 98vw; /* 使用视口宽度的 98%，留一点边距 */
    margin-left: auto;
    margin-right: auto;
  }
}

/* 如果屏幕非常大，可以增加一个更大的断点 */
@media (min-width: 1400px) {
  .modal-xl {
    max-width: 99vw; /* 例如，在更大的屏幕上使用 99vw */
  }
}


/* --- 2. 调整设备列表网格为10列 --- */
.machine-modal-list {
  max-height: 400px; /* 可根据需要调整 */
  overflow-y: auto;
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
  padding: 0.5rem 2px 0.5rem 2px; /* top, right, bottom, left */
  display: grid;
  /* --- 关键修改点：设置为10列 --- */
  grid-template-columns: repeat(10, 1fr);
  /* 减小间距以节省空间 */
  gap: 4px; /* 可根据视觉效果微调 */
}

/* --- 3. 调整单个设备项样式以适应更窄的宽度 --- */
.machine-modal-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  /* 减小内边距 */
  padding: 6px 2px;
  text-align: center;
  /* 可以稍微减小字体大小 */
  font-size: 0.85rem;
  /* 保持最小高度一致 */
  min-height: 55px;
  /* 保持边框和圆角 */
  border: 1px solid #e9ecef;
  border-radius: 0.25rem;
  cursor: pointer;
  transition: all 0.2s ease;
  /* 防止内容溢出 */
  overflow: hidden;
}

.machine-modal-item:hover {
  background-color: #f0f8ff;
  border-color: var(--primary);
  transform: scale(1.02); /* 轻微放大效果 */
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.machine-modal-item.selected {
  background-color: #e8f4ff;
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(44, 111, 187, 0.25);
}

.machine-modal-id {
  font-weight: bold;
  color: var(--primary);
  /* 字体大小可以和 .machine-modal-item 保持一致或稍大一点 */
  font-size: 0.9rem;
  margin-bottom: 0.1rem;
  /* 防止编号过长溢出 */
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  width: 100%;
}

.machine-modal-desc {
  font-size: 0.75rem; /* 稍微减小描述字体 */
  color: #6c757d;
  margin-top: 0.1rem;
  text-align: center;
  /* 确保描述也限制在一行内并有省略号 */
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  width: 100%;
}

/* --- 4. （可选）优化搜索框 --- */
.machine-search-container .form-control {
  padding-left: 2.5rem; /* 为图标留出空间 */
}

/* --- 5. （可选）调整响应式断点 --- */
/* 确保在更小的屏幕上会自动调整列数 */
@media (max-width: 1200px) {
  .machine-modal-list {
    /* 例如，在中等屏幕下降到 8 列 */
    grid-template-columns: repeat(8, 1fr);
  }
}
@media (max-width: 992px) {
  .machine-modal-list {
    /* 平板每行 6 个 */
    grid-template-columns: repeat(6, 1fr);
  }
}
@media (max-width: 768px) {
  .machine-modal-list {
    /* 小屏幕每行 4 个 */
    grid-template-columns: repeat(4, 1fr);
  }
}
@media (max-width: 576px) {
  .machine-modal-list {
    /* 手机每行 2 个 */
    grid-template-columns: repeat(2, 1fr);
  }
}

/* --- 6. （临时）确保修改生效 --- */
/* 最好通过调整CSS顺序或特异性来避免使用 !important，
   但如果修改后未生效，可以临时使用 !important 测试。
   测试成功后，应移除 !important 并通过正确的CSS优先级管理样式。 */
/*
.machine-modal-list {
    grid-template-columns: repeat(10, 1fr) !important;
    gap: 4px !important;
    padding-left: 2px !important;
    padding-right: 2px !important;
}
*/
  </style>
</head>
<body>
  
  <!-- 您的所有 HTML 结构代码都保持不变 -->
  <div class="container">
    <div class="header">
      <h3><i class="fas fa-industry me-2"></i>纺织厂报工系统</h3>
    </div>
    <!-- 导航选项卡 -->
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login-pane" type="button" role="tab">
          <i class="fas fa-sign-in-alt me-2"></i>工号登录
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="report-tab" data-bs-toggle="tab" data-bs-target="#report-pane" type="button" role="tab" disabled>
          <i class="fas fa-edit me-2"></i>报工录入
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary-pane" type="button" role="tab">
          <i class="fas fa-list-alt me-2"></i>报工汇总
        </button>
      </li>
      <!-- 新增员工管理选项卡 -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="worker-tab" data-bs-toggle="tab" data-bs-target="#worker-pane" type="button" role="tab">
          <i class="fas fa-users me-2"></i>员工管理
        </button>
      </li>
      <!-- 新增设备管理选项卡 -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="machine-tab" data-bs-toggle="tab" data-bs-target="#machine-pane" type="button" role="tab">
          <i class="fas fa-cogs me-2"></i>设备管理
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-pane" type="button" role="tab">
          <i class="fas fa-cog me-2"></i>系统设置
        </button>
      </li>
    </ul>
    <!-- 选项卡内容 -->
    <div class="tab-content" id="mainTabsContent">
      <!-- 工号登录面板 -->
      <div class="tab-pane fade show active" id="login-pane" role="tabpanel">
        <div class="login-card card">
          <div class="card-header">选择工号登录</div>
          <div class="card-body">
            <div class="form-group mb-3">
              <label for="workerSelect" class="form-label">选择员工：</label>
              <select id="workerSelect" class="form-control">
                <option value="">-- 请选择员工 --</option>
              </select>
            </div>
            <!-- 新增作业区域选择 -->
            <div class="form-group mb-4">
              <label for="workAreaSelect" class="form-label">作业区域：</label>
              <select id="workAreaSelect" class="form-control">
                <option value="10车间">10车间</option>
                <option value="纬编百兴G1-4楼">纬编百兴G1-4楼</option>
                <option value="纬编百兴G1-5楼">纬编百兴G1-5楼</option>
                <option value="纬编百兴G2-1楼">纬编百兴G2-1楼</option>
                <option value="纬编百兴G2-2楼">纬编百兴G2-2楼</option>
                <option value="纬编百兴G2-4楼">纬编百兴G2-4楼</option>
                <option value="纬编百兴G2-5楼">纬编百兴G2-5楼</option>
              </select>
            </div>
            <div class="text-center">
              <button id="confirmWorkerBtn" class="btn btn-primary w-100 btn-hover-grow">
                <i class="fas fa-check-circle me-2"></i>确认登录
              </button>
            </div>
            <div id="workerInfo" class="mt-4 alert alert-info" style="display: none;"></div>
          </div>
        </div>
      </div>
      <!-- 报工录入面板 -->
      <div class="tab-pane fade" id="report-pane" role="tabpanel">
        <div class="worker-info alert alert-success d-flex justify-content-between align-items-center">
          <div>
            <strong>当前用户：</strong>
            <span id="currentWorkerName"></span>
            (<span id="currentWorkerId"></span>)
            <span class="ms-2 badge bg-primary badge-pill" id="currentWorkArea"></span>
          </div>
        </div>
        <div class="card">
          <div class="card-header">报工信息录入</div>
          <div class="card-body">
            <form id="reportForm">
              <div class="row mb-3">
                <div class="col-md-6">
    <div class="form-group">
        <label for="machineId">设备编号：</label>
        <div class="input-group">
            <input type="text" id="machineId" class="form-control" placeholder="请输入或选择设备编号" required>
            <button type="button" id="selectMachineBtn" class="btn btn-outline-primary" title="选择设备"><i class="fas fa-list"></i></button>
            <button type="button" id="toggleMachineInputBtn" class="btn btn-outline-secondary btn-hover-grow" title="切换手动输入"><i class="fas fa-keyboard"></i></button>
        </div>
        <div class="form-text">点击 <i class="fas fa-list"></i> 选择设备，或点击 <i class="fas fa-keyboard"></i> 手动输入</div>
    </div>
</div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="greyClothId">坯布编号：</label>
                    <input type="text" id="greyClothId" class="form-control" required>
                    <div id="greyClothSuggestions" class="dropdown-menu"></div>
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="materialCode">原料编号：</label>
                    <div class="input-group">
                      <input type="text" id="materialCode" class="form-control" readonly>
                      <button type="button" id="toggleMaterialInputBtn" class="btn btn-outline-secondary btn-hover-grow">
                        <i class="fas fa-pencil-alt"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="materialName">原料名称：</label>
                    <input type="text" id="materialName" class="form-control" readonly>
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="operationType">操作类型：</label>
                    <select id="operationType" class="form-control" required>
                      <option value="上纱" selected>上纱</option>
                      <option value="下纱">下纱</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="grainCount">粒数：</label>
                    <input type="number" id="grainCount" class="form-control" min="1" max="300" required>
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="grainWeight">粒重（KG）：</label>
                    <div class="input-group">
                      <input type="number" id="grainWeight" class="form-control" min="0" max="15" step="0.5" placeholder="请输入粒重" required>
                      <select class="form-select" id="grainWeightOptions" style="max-width: 150px;">
                        <option value="">常用值</option>
                        <option value="1">1</option>
                        <option value="1.5">1.5</option>
                        <option value="2">2</option>
                        <option value="2.5">2.5</option>
                        <option value="3">3</option>
                        <option value="3.5">3.5</option>
                        <option value="4">4</option>
                        <option value="4.5">4.5</option>
                        <option value="5">5</option>
                        <option value="5.5">5.5</option>
                        <option value="6">6</option>
                        <option value="6.5">6.5</option>
                        <option value="7">7</option>
                        <option value="7.5">7.5</option>
                        <option value="8">8</option>
                        <option value="8.5">8.5</option>
                        <option value="9">9</option>
                        <option value="9.5">9.5</option>
                        <option value="10">10</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="productionDate">生产日期：</label>
                    <input type="date" id="productionDate" class="form-control" required>
                  </div>
                </div>
              </div>
              <div class="form-group mb-4">
                <label for="remarks">备注：</label>
                <textarea id="remarks" class="form-control" rows="2"></textarea>
              </div>
              <div class="d-flex justify-content-between">
                <div>
                  <button type="submit" class="btn btn-primary me-2 btn-hover-grow">
                    <i class="fas fa-paper-plane me-2"></i>提交报工
                  </button>
                  <button type="button" id="resetReportBtn" class="btn btn-secondary me-2 btn-hover-grow">
                    <i class="fas fa-redo me-2"></i>重置
                  </button>
                </div>
                <button type="button" id="uploadExcelBtn" class="btn btn-info btn-hover-grow">
                  <i class="fas fa-upload me-2"></i>上传匹配表
                </button>
              </div>
            </form>
            <div id="matchResult" class="match-result mt-4" style="display: none;"></div>
          </div>
        </div>
      </div>
      <!-- 报工汇总面板 -->
      <div class="tab-pane fade" id="summary-pane" role="tabpanel">
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="stat-card">
              <i class="fas fa-file-alt"></i>
              <div class="value" id="totalReports">0</div>
              <div class="label">总报工数</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <i class="fas fa-cubes"></i>
              <div class="value" id="totalGrains">0</div>
              <div class="label">总粒数</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <i class="fas fa-weight-hanging"></i>
              <div class="value" id="totalWeight">0</div>
              <div class="label">总重量(KG)</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <i class="fas fa-users"></i>
              <div class="value" id="totalWorkers">0</div>
              <div class="label">员工总数</div>
            </div>
          </div>
        </div>
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>报工数据筛选</span>
            <button id="exportExcelBtn" class="btn btn-success btn-sm btn-hover-grow">
              <i class="fas fa-file-excel me-2"></i>导出Excel
            </button>
          </div>
          <div class="card-body">
            <div class="row mb-4">
              <div class="col-md-3">
                <label for="summaryWorkerId">按工号筛选：</label>
                <select id="summaryWorkerId" class="form-control">
                  <option value="">全部工号</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="summaryWorkArea">作业区域：</label>
                <select id="summaryWorkArea" class="form-control">
                  <option value="">全部区域</option>
                  <option value="10车间">10车间</option>
                  <option value="纬编百兴G1-4楼">纬编百兴G1-4楼</option>
                  <option value="纬编百兴G1-5楼">纬编百兴G1-5楼</option>
                  <option value="纬编百兴G2-1楼">纬编百兴G2-1楼</option>
                  <option value="纬编百兴G2-2楼">纬编百兴G2-2楼</option>
                  <option value="纬编百兴G2-4楼">纬编百兴G2-4楼</option>
                  <option value="纬编百兴G2-5楼">纬编百兴G2-5楼</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="summaryDateFrom">开始日期：</label>
                <input type="date" id="summaryDateFrom" class="form-control">
              </div>
              <div class="col-md-3">
                <label for="summaryDateTo">结束日期：</label>
                <input type="date" id="summaryDateTo" class="form-control">
              </div>
            </div>
            <div class="row mb-4">
              <div class="col-md-3">
                <label for="summaryOperationType">操作类型：</label>
                <select id="summaryOperationType" class="form-control">
                  <option value="">全部类型</option>
                  <option value="上纱">上纱</option>
                  <option value="下纱">下纱</option>
                </select>
              </div>
              <div class="col-md-3">
                <label>&nbsp;</label>
                <button id="filterSummaryBtn" class="btn btn-primary w-100 btn-hover-grow">
                  <i class="fas fa-filter me-2"></i>筛选
                </button>
              </div>
              <div class="col-md-6">
                <label>&nbsp;</label>
                <button id="clearFilterBtn" class="btn btn-outline-secondary w-100 btn-hover-grow">
                  <i class="fas fa-times-circle me-2"></i>清除筛选
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-bordered table-hover">
                <thead class="table-light">
                  <tr>
                    <th>序号</th>
                    <th>工号</th>
                    <th>姓名</th>
                    <th>作业区域</th>
                    <th>设备编号</th>
                    <th>坯布编号</th>
                    <th>原料名称</th>
                    <th>操作类型</th>
                    <th>粒数</th>
                    <th>粒重(KG)</th>
                    <th>总重量(KG)</th>
                    <th>日期</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="summaryTableBody">
                  <tr>
                    <td colspan="13" class="text-center">暂无数据</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <!-- 分页控件 -->
            <div class="pagination-container">
              <div class="page-info">
                共 <span id="totalRecords">0</span> 条记录，每页 30 条
              </div>
              <div class="pagination-buttons">
                <button id="prevPageBtn" class="btn btn-sm btn-outline-primary" disabled>
                  <i class="fas fa-chevron-left me-1"></i>上一页
                </button>
                <span class="mx-2">
                  第 <span id="currentPage">1</span> 页 / 共 <span id="totalPages">1</span> 页
                </span>
                <button id="nextPageBtn" class="btn btn-sm btn-outline-primary" disabled>
                  下一页<i class="fas fa-chevron-right ms-1"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">报工类型分布</div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="operationTypeChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">员工报工量排名</div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="workerRankingChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- 新增员工管理面板 -->
      <div class="tab-pane fade" id="worker-pane" role="tabpanel">
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="worker-stat">
              <div class="worker-stat-value" id="totalWorkersCount">0</div>
              <div class="worker-stat-label">员工总数</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="worker-stat">
              <div class="worker-stat-value" id="activeWorkersCount">0</div>
              <div class="worker-stat-label">活跃员工</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="worker-stat">
              <div class="worker-stat-value" id="avgReports">0</div>
              <div class="worker-stat-label">人均报工数</div>
            </div>
          </div>
        </div>
        <div class="card worker-card mb-4">
          <div class="card-header worker-card-header">
            <i class="fas fa-user-plus me-2"></i>添加新员工
          </div>
          <div class="card-body">
            <div class="worker-form">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group mb-3">
                    <label for="newWorkerId" class="form-label">工号：</label>
                    <input type="text" id="newWorkerId" class="form-control" placeholder="输入新工号">
                    <div class="form-text">工号必须是唯一的数字标识</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group mb-3">
                    <label for="newWorkerName" class="form-label">姓名：</label>
                    <input type="text" id="newWorkerName" class="form-control" placeholder="输入姓名">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12">
                  <div class="d-grid">
                    <button id="addWorkerBtn" class="btn btn-primary btn-hover-grow">
                      <i class="fas fa-user-plus me-2"></i>添加员工
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card worker-card">
          <div class="card-header worker-card-header">
            <i class="fas fa-users me-2"></i>员工列表管理
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-bordered table-hover">
                <thead class="table-light">
                  <tr>
                    <th>序号</th>
                    <th>工号</th>
                    <th>姓名</th>
                    <th>报工次数</th>
                    <th>最近报工日期</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="workersTableBody">
                  <tr>
                    <td colspan="6" class="text-center">暂无员工数据</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
       <!-- 新增设备管理面板 -->
       <div class="tab-pane fade" id="machine-pane" role="tabpanel">
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="machine-stat">
              <div class="machine-stat-value" id="totalMachinesCount">0</div>
              <div class="machine-stat-label">设备总数</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="machine-stat">
              <div class="machine-stat-value" id="totalAreasCount">0</div>
              <div class="machine-stat-label">作业区域数</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="machine-stat">
              <div class="machine-stat-value" id="avgMachinesPerArea">0</div>
              <div class="machine-stat-label">平均每区域设备数</div>
            </div>
          </div>
        </div>
<!-- 新增：全部删除按钮区域 -->
<div class="row mb-3">
  <div class="col-md-12">
    <!-- 全部删除按钮 -->
    <button id="deleteAllMachinesBtn" class="btn btn-danger btn-sm" title="删除所有设备">
      <i class="fas fa-trash-alt me-1"></i>全部删除
    </button>
    <!-- 如果您希望按钮靠右对齐，可以使用下面的代码替换上面的 button 标签：
    <div class="text-end">
      <button id="deleteAllMachinesBtn" class="btn btn-danger btn-sm" title="删除所有设备">
        <i class="fas fa-trash-alt me-1"></i>全部删除
      </button>
    </div>
    -->
  </div>
</div>
<!-- /新增：全部删除按钮区域 -->
        <div class="card machine-card mb-4">
          <div class="card-header machine-card-header d-flex justify-content-between align-items-center">
            <span><i class="fas fa-cog me-2"></i>添加新设备</span>
            <button id="importMachinesBtn" class="btn btn-sm btn-light">
              <i class="fas fa-file-import me-2"></i>批量导入
            </button>
          </div>
          <div class="card-body">
            <div class="machine-form">
              <div class="row">
                <div class="col-md-4">
                  <div class="form-group mb-3">
                    <label for="newMachineArea" class="form-label">作业区域：</label>
                    <select id="newMachineArea" class="form-control">
                      <option value="10车间">10车间</option>
                      <option value="纬编百兴G1-4楼">纬编百兴G1-4楼</option>
                      <option value="纬编百兴G1-5楼">纬编百兴G1-5楼</option>
                      <option value="纬编百兴G2-1楼">纬编百兴G2-1楼</option>
                      <option value="纬编百兴G2-2楼">纬编百兴G2-2楼</option>
                      <option value="纬编百兴G2-4楼">纬编百兴G2-4楼</option>
                      <option value="纬编百兴G2-5楼">纬编百兴G2-5楼</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group mb-3">
                    <label for="newMachineId" class="form-label">设备编号：</label>
                    <input type="text" id="newMachineId" class="form-control" placeholder="输入设备编号 (例如: W001)">
                    <div class="form-text">编号必须唯一</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group mb-3">
                    <label for="newMachineDesc" class="form-label">设备描述：</label>
                    <input type="text" id="newMachineDesc" class="form-control" placeholder="输入设备描述 (可选)">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12">
                  <div class="d-grid">
                    <button id="addMachineBtn" class="btn btn-primary btn-hover-grow">
                      <i class="fas fa-plus-circle me-2"></i>添加设备
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card machine-card">
          <div class="card-header machine-card-header">
            <i class="fas fa-list me-2"></i>设备列表管理
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="machineAreaFilter" class="form-label">按作业区域筛选：</label>
              <select id="machineAreaFilter" class="form-control">
                <option value="">全部区域</option>
                <option value="10车间">10车间</option>
                <option value="纬编百兴G1-4楼">纬编百兴G1-4楼</option>
                <option value="纬编百兴G1-5楼">纬编百兴G1-5楼</option>
                <option value="纬编百兴G2-1楼">纬编百兴G2-1楼</option>
                <option value="纬编百兴G2-2楼">纬编百兴G2-2楼</option>
                <option value="纬编百兴G2-4楼">纬编百兴G2-4楼</option>
                <option value="纬编百兴G2-5楼">纬编百兴G2-5楼</option>
              </select>
            </div>
            <div class="table-responsive">
              <table class="table table-bordered table-hover">
                <thead class="table-light">
                  <tr>
                    <th>序号</th>
                    <th>作业区域</th>
                    <th>设备编号</th>
                    <th>设备描述</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="machinesTableBody">
                  <tr>
                    <td colspan="5" class="text-center">暂无设备数据</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <!-- 系统设置面板 -->
      <div class="tab-pane fade" id="settings-pane" role="tabpanel">
        <div class="card mb-4">
          <div class="card-header">数据管理</div>
          <div class="card-body">
            <div class="alert alert-info mb-4">
              <i class="fas fa-info-circle me-2"></i>
              为防止数据溢出，请定期清理旧数据或导出备份
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="card mb-3">
                  <div class="card-body">
                    <h5 class="card-title">按日期删除数据</h5>
                    <div class="mb-3">
                      <label for="deleteDateFrom" class="form-label">开始日期：</label>
                      <input type="date" id="deleteDateFrom" class="form-control">
                    </div>
                    <div class="mb-3">
                      <label for="deleteDateTo" class="form-label">结束日期：</label>
                      <input type="date" id="deleteDateTo" class="form-control">
                    </div>
                    <button id="deleteByDateBtn" class="btn btn-danger w-100 btn-hover-grow">
                      <i class="fas fa-trash-alt me-2"></i>删除选定日期数据
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">备份与恢复</h5>
                    <button id="exportAllDataBtn" class="btn btn-success w-100 mb-3 btn-hover-grow">
                      <i class="fas fa-download me-2"></i>导出所有数据
                    </button>
                    <button id="clearAllDataBtn" class="btn btn-danger w-100 btn-hover-grow">
                      <i class="fas fa-trash-alt me-2"></i>清空所有数据
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- 新增测试数据生成功能 -->
        <div class="card mb-4 test-data-card">
          <div class="card-header">系统压力测试</div>
          <div class="card-body">
            <div class="alert alert-warning mb-4">
              <i class="fas fa-exclamation-triangle me-2"></i>
              此功能用于测试系统最大报工量，生成的数据为模拟数据
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group mb-3">
                  <label for="testDataCount" class="form-label">生成记录数量：</label>
                  <input type="number" id="testDataCount" class="form-control" min="100" max="100000" value="1000">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group mb-3">
                  <label for="testDataDateRange" class="form-label">日期范围：</label>
                  <select id="testDataDateRange" class="form-control">
                    <option value="30">最近30天</option>
                    <option value="90">最近90天</option>
                    <option value="180">最近180天</option>
                    <option value="365">最近1年</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <div class="d-flex justify-content-between mb-1">
                <span>测试数据生成进度：</span>
                <span id="testProgressText">0%</span>
              </div>
              <div class="progress test-data-progress">
                <div id="testDataProgress" class="progress-bar bg-success progress-bar-striped" role="progressbar" style="width: 0%"></div>
              </div>
            </div>
            <div class="text-center">
              <button id="generateTestDataBtn" class="btn btn-info w-100 btn-hover-grow">
                <i class="fas fa-bolt me-2"></i>生成测试数据
              </button>
            </div>
            <div id="testDataStatus" class="mt-3 test-data-status"></div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">系统信息</div>
          <div class="card-body">
            <div class="mb-3">
              <div class="d-flex justify-content-between">
                <span>本地存储使用情况：</span>
                <span id="storageUsage">0 KB / 0 KB</span>
              </div>
              <div class="progress mt-2" style="height: 10px;">
                <div id="storageProgress" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%"></div>
              </div>
            </div>
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              当存储使用超过80%时，建议清理旧数据或导出备份
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- 加载指示器 -->
  <div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">加载中...</span>
    </div>
  </div>
  <!-- 原料匹配表上传模态框 -->
  <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadModalLabel">上传原料匹配表</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="excelFile" class="form-label">选择Excel文件：</label>
            <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls">
          </div>
          <div id="uploadStatus" class="mb-3"></div>
          <div class="table-responsive">
            <table class="table table-bordered mt-3" id="excelPreview">
              <thead>
                <tr>
                  <th>坯布编号</th>
                  <th>原料编号</th>
                  <th>原料名称</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="3" class="text-center">上传Excel文件后预览数据</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
          <button type="button" id="processExcelBtn" class="btn btn-primary">处理文件</button>
        </div>
      </div>
    </div>
  </div>
  <!-- 编辑报工记录模态框 -->
  <div class="modal fade" id="editReportModal" tabindex="-1" aria-labelledby="editReportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editReportModalLabel">编辑报工记录</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editReportForm">
            <input type="hidden" id="editReportId">
            <div class="mb-3">
              <label for="editWorkerId" class="form-label">工号</label>
              <input type="text" id="editWorkerId" class="form-control" readonly>
            </div>
            <div class="mb-3">
              <label for="editWorkerName" class="form-label">姓名</label>
              <input type="text" id="editWorkerName" class="form-control" readonly>
            </div>
            <div class="mb-3">
              <label for="editWorkArea" class="form-label">作业区域</label>
              <input type="text" id="editWorkArea" class="form-control" readonly>
            </div>
            <div class="mb-3">
              <label for="editMachineId" class="form-label">设备编号</label>
              <input type="text" id="editMachineId" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="editGreyClothId" class="form-label">坯布编号</label>
              <input type="text" id="editGreyClothId" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="editMaterialName" class="form-label">原料名称</label>
              <input type="text" id="editMaterialName" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="editOperationType" class="form-label">操作类型</label>
              <select id="editOperationType" class="form-control" required>
                <option value="上纱">上纱</option>
                <option value="下纱">下纱</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editGrainCount" class="form-label">粒数</label>
              <input type="number" id="editGrainCount" class="form-control" min="1" max="300" required>
            </div>
            <div class="mb-3">
              <label for="editGrainWeight" class="form-label">粒重(KG)</label>
              <div class="input-group">
                <input type="number" id="editGrainWeight" class="form-control" min="0" max="15" step="0.5" required>
                <select class="form-select" id="editGrainWeightOptions" style="max-width: 150px;">
                  <option value="">常用值</option>
                  <option value="1">1</option>
                  <option value="1.5">1.5</option>
                  <option value="2">2</option>
                  <option value="2.5">2.5</option>
                  <option value="3">3</option>
                  <option value="3.5">3.5</option>
                  <option value="4">4</option>
                  <option value="4.5">4.5</option>
                  <option value="5">5</option>
                  <option value="5.5">5.5</option>
                  <option value="6">6</option>
                  <option value="6.5">6.5</option>
                  <option value="7">7</option>
                  <option value="7.5">7.5</option>
                  <option value="8">8</option>
                  <option value="8.5">8.5</option>
                  <option value="9">9</option>
                  <option value="9.5">9.5</option>
                  <option value="10">10</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label for="editProductionDate" class="form-label">生产日期</label>
              <input type="date" id="editProductionDate" class="form-control" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" id="saveReportBtn" class="btn btn-primary">保存修改</button>
        </div>
      </div>
    </div>
  </div>
  <!-- 导出进度模态框 -->
  <div class="modal fade" id="exportProgressModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">导出数据</h5>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span>导出进度：</span>
              <span id="exportProgressText">0%</span>
            </div>
            <div class="progress">
              <div id="exportProgressBar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%"></div>
            </div>
          </div>
          <div id="exportStatus" class="mt-2"></div>
        </div>
      </div>
    </div>
  </div>
   <!-- 设备批量导入模态框 -->
  <div class="modal fade" id="importMachinesModal" tabindex="-1" aria-labelledby="importMachinesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="importMachinesModalLabel">批量导入设备</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="importMachinesFile" class="form-label">选择Excel文件：</label>
            <input type="file" class="form-control" id="importMachinesFile" accept=".xlsx,.xls">
          </div>
          <div id="importMachinesStatus" class="mb-3"></div>
          <div class="table-responsive">
            <table class="table table-bordered mt-3" id="importMachinesPreview">
              <thead>
                <tr>
                  <th>作业区域</th>
                  <th>设备编号</th>
                  <th>设备描述</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="3" class="text-center">上传Excel文件后预览数据</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
          <button type="button" id="processImportMachinesBtn" class="btn btn-primary">导入设备</button>
        </div>
      </div>
    </div>
  </div>
  <!-- 设备选择弹窗 - 更新为网格布局 -->
  <div class="modal fade" id="machineSelectModal" tabindex="-1" aria-labelledby="machineSelectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl"> <!-- 使用更大的模态框以适应网格 -->
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="machineSelectModalLabel">选择设备</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="machine-search-container">
            <i class="fas fa-search machine-search-icon"></i>
            <input type="text" id="machineSearchInput" class="form-control" placeholder="搜索设备编号或描述...">
          </div>
          <div id="machineSelectList" class="machine-modal-list">
            <div class="text-center text-muted">暂无设备数据</div>
          </div>
          <div class="machine-modal-footer">
            <div class="machine-modal-count">
              共 <span id="machineModalCount">0</span> 台设备
            </div>
            <div class="machine-modal-buttons">
              <button type="button" id="closeMachineModalBtn" class="btn btn-secondary btn-sm">
                关闭
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // #################################################################
    // ###########       START: MODIFIED JAVASCRIPT          ###########
    // #################################################################

    // 全局变量
    let currentWorkerId = '';
    let currentWorkArea = '';
    let materialMatches = [];
    let filteredReports = [];
    let workers = []; // 注意：员工数据暂时仍在前端管理，未连接后端
    let reports = [];
    let machines = []; // 注意：设备数据暂时仍在前端管理，未连接后端
    let typeChartInstance = null;
    let rankingChartInstance = null;
    let manualInputEnabled = false;
    let manualMachineInputEnabled = false;
    let debounceTimer = null;
    // 分页相关变量
    let currentPage = 1;
    const itemsPerPage = 30;
    
    // --- DELETED: 删除了所有 IndexedDB 相关的变量和初始化函数 ---

    // DOM元素
    const tabs = bootstrap.Tab.getOrCreateInstance(document.getElementById('mainTabs'));
    const reportTab = document.getElementById('report-tab');
    const greyClothIdInput = document.getElementById('greyClothId');
    const greyClothSuggestions = document.getElementById('greyClothSuggestions');
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    // 显示加载指示器
    function showLoading() {
      loadingOverlay.style.display = 'flex';
    }
    // 隐藏加载指示器
    function hideLoading() {
      loadingOverlay.style.display = 'none';
    }

    // +++ NEW: 从我们的 Netlify 后端接口加载数据 +++
    async function loadDataFromBackend() {
        showLoading();
        try {
            // Netlify Functions 的访问路径是 /.netlify/functions/[函数文件名]
            const response = await fetch('/.netlify/functions/reports');
            
            if (!response.ok) {
                throw new Error(`网络错误: ${response.statusText}`);
            }
            
            const reportsData = await response.json();
            
            // 将从后端获取的数据更新到前端的全局变量中
            reports = reportsData;
            filteredReports = [...reports];
            
            // 调用您已有的函数来刷新界面
            updateSummaryStats();
            // 注意：员工和设备数据仍是本地的，所以相关UI更新函数暂时保留
            updateWorkersTable(); 
            updateWorkerStats();
            updateMachinesTable();
            updateMachineStats();

        } catch (error) {
            console.error('从后端加载数据失败:', error);
            showAlert('数据加载失败，请检查网络并刷新重试', 'danger');
        } finally {
            hideLoading();
        }
    }


    // 初始化
    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('productionDate').valueAsDate = new Date();
      
      try {
        // --- MODIFIED: 修改了页面加载逻辑 ---
        showLoading();
        
        // 不再需要 initDatabase()
        await loadDataFromBackend(); // 从新的后端加载数据
        
        // --- 员工数据暂时从localStorage加载，未来可以也改成后端 ---
        const savedWorkers = localStorage.getItem('workers');
        if (savedWorkers) {
            workers = JSON.parse(savedWorkers);
        } else {
             workers = [
              { workerId: '2101001', name: '张三' },
              { workerId: '2101002', name: '李四' },
              { workerId: '2101003', name: '王五' }
            ];
        }
        updateWorkerSelect();
        updateWorkersTable();


        initEventListeners();
        startMemoryMonitoring();
      } catch (error) {
        console.error('初始化失败:', error);
        showAlert('系统初始化失败，请刷新页面重试', 'danger');
      } finally {
          hideLoading();
      }
    });

    // 启动内存监控
    function startMemoryMonitoring() {
      updateMemoryUsage();
      setInterval(updateMemoryUsage, 5000);
    }
    
    // 更新内存使用情况 (暂时保留，未来可以移除)
    function updateMemoryUsage() {
      try {
        const reportsSize = JSON.stringify(reports).length;
        const workersSize = JSON.stringify(workers).length;
        const matchesSize = JSON.stringify(materialMatches).length;
        const machinesSize = JSON.stringify(machines).length;
        const totalSize = reportsSize + workersSize + matchesSize + machinesSize;
        const totalKB = (totalSize / 1024).toFixed(2);
        const maxStorage = 10 * 1024; // 10MB in KB
        const usagePercentage = Math.min(100, (totalKB / maxStorage) * 100);
        document.getElementById('storageUsage').textContent = `${totalKB} KB / ${maxStorage} KB`;
        document.getElementById('storageProgress').style.width = `${usagePercentage}%`;
        const storageProgress = document.getElementById('storageProgress');
        storageProgress.classList.remove('bg-warning', 'bg-danger');
        if (usagePercentage > 80) {
          storageProgress.classList.add('bg-danger');
        } else if (usagePercentage > 60) {
          storageProgress.classList.add('bg-warning');
        }
      } catch (e) {
        console.error('存储监控出错:', e);
      }
    }

    // 更新员工选择下拉框
    function updateWorkerSelect() {
      const workerSelect = document.getElementById('workerSelect');
      workerSelect.innerHTML = '<option value="">-- 请选择员工 --</option>';
      workers.forEach(worker => {
        const option = document.createElement('option');
        option.value = worker.workerId;
        option.textContent = `${worker.workerId} - ${worker.name}`;
        workerSelect.appendChild(option);
      });
    }

    // 提交报工 - --- MODIFIED: 修改为调用后端API ---
    async function handleSubmit(e) {
      e.preventDefault();
      
      const currentWorker = workers.find(w => w.workerId === currentWorkerId);
      const grainCountValue = parseInt(document.getElementById('grainCount').value);
      const grainWeightValue = parseFloat(document.getElementById('grainWeight').value);

      const report = {
          reportId: Date.now().toString(),
          workerId: currentWorkerId,
          workerName: currentWorker ? currentWorker.name : '未知',
          workArea: currentWorkArea,
          machineId: document.getElementById('machineId').value.trim(),
          greyClothId: document.getElementById('greyClothId').value.trim(),
          operationType: document.getElementById('operationType').value,
          materialCode: document.getElementById('materialCode').value.trim(),
          materialName: document.getElementById('materialName').value.trim(),
          grainCount: grainCountValue,
          grainWeight: grainWeightValue,
          totalWeight: grainCountValue * grainWeightValue,
          productionDate: document.getElementById('productionDate').value,
          remarks: document.getElementById('remarks').value.trim(),
          // 'timestamp' 字段由 Supabase 数据库自动生成，前端无需提供
      };

      if (!report.workerId || !report.machineId || !report.greyClothId || !report.productionDate) {
          showAlert('请填写所有必填项', 'danger');
          return;
      }

      try {
        showLoading();
        
        const response = await fetch('/.netlify/functions/reports', {
          method: 'POST', // 使用 POST 方法来发送数据
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(report), // 将 report 对象转换为 JSON 字符串发送
        });

        if (!response.ok) {
          const errorBody = await response.json();
          throw new Error(errorBody.error || '提交失败');
        }
        
        showAlert('报工提交成功！', 'success');
        resetReportForm();
        
        // 提交成功后，重新从后端加载所有最新数据，刷新界面
        await loadDataFromBackend();
        
        tabs.show(document.getElementById('summary-tab'));

      } catch (error) {
        console.error('保存报工记录失败:', error);
        showAlert(`提交失败: ${error.message}`, 'danger');
      } finally {
          hideLoading();
      }
    }

    // --- 以下是其他未修改或仅做微调的函数，保持其原有功能 ---
    
    function initEventListeners() {
      document.getElementById('confirmWorkerBtn').addEventListener('click', confirmWorker);
      document.getElementById('reportForm').addEventListener('submit', handleSubmit);
      document.getElementById('resetReportBtn').addEventListener('click', resetReportForm);
      greyClothIdInput.addEventListener('input', handleGreyClothInput);
      document.getElementById('uploadExcelBtn').addEventListener('click', () => {
        document.getElementById('uploadModal').querySelector('#uploadStatus').innerHTML = '';
        document.getElementById('excelPreview').querySelector('tbody').innerHTML =
          '<tr><td colspan="3" class="text-center">上传Excel文件后预览数据</td></tr>';
        new bootstrap.Modal(document.getElementById('uploadModal')).show();
      });
      document.getElementById('processExcelBtn').addEventListener('click', processExcelFile);
      document.getElementById('filterSummaryBtn').addEventListener('click', filterSummaryData);
      document.getElementById('clearFilterBtn').addEventListener('click', clearFilters);
      document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
      document.getElementById('addWorkerBtn').addEventListener('click', addNewWorker);
      document.getElementById('clearAllDataBtn').addEventListener('click', clearAllData);
      document.getElementById('saveReportBtn').addEventListener('click', saveReportChanges);
      document.getElementById('deleteByDateBtn').addEventListener('click', deleteByDate);
      document.getElementById('exportAllDataBtn').addEventListener('click', exportAllData);
      document.getElementById('toggleMaterialInputBtn').addEventListener('click', toggleManualInput);
      document.getElementById('toggleMachineInputBtn').addEventListener('click', toggleManualMachineInput);
      document.getElementById('selectMachineBtn').addEventListener('click', openMachineSelectModal);
      document.getElementById('grainWeightOptions').addEventListener('change', function() {
        if (this.value) {
          document.getElementById('grainWeight').value = this.value;
        }
      });
      document.getElementById('editGrainWeightOptions').addEventListener('change', function() {
        if (this.value) {
          document.getElementById('editGrainWeight').value = this.value;
        }
      });
      document.getElementById('summaryTableBody').addEventListener('click', (e) => {
        if (e.target.classList.contains('edit-report') || e.target.closest('.edit-report')) {
          const reportId = e.target.closest('.edit-report').dataset.reportId;
          editReport(reportId);
        }
        if (e.target.classList.contains('delete-report') || e.target.closest('.delete-report')) {
          const reportId = e.target.closest('.delete-report').dataset.reportId;
          deleteReport(reportId);
        }
      });
      document.getElementById('workersTableBody').addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-worker') || e.target.closest('.delete-worker')) {
          const workerId = e.target.closest('.delete-worker').dataset.workerId;
          deleteWorker(workerId);
        }
      });
      document.getElementById('excelFile').addEventListener('change', previewExcel);
      document.getElementById('prevPageBtn').addEventListener('click', goToPrevPage);
      document.getElementById('nextPageBtn').addEventListener('click', goToNextPage);
      document.getElementById('generateTestDataBtn').addEventListener('click', generateTestData);
      document.getElementById('report-pane').addEventListener('show.bs.tab', function() {
        document.getElementById('productionDate').valueAsDate = new Date();
      });
      document.getElementById('addMachineBtn').addEventListener('click', addNewMachine);
      document.getElementById('importMachinesBtn').addEventListener('click', () => {
        document.getElementById('importMachinesModal').querySelector('#importMachinesStatus').innerHTML = '';
        document.getElementById('importMachinesPreview').querySelector('tbody').innerHTML =
          '<tr><td colspan="3" class="text-center">上传Excel文件后预览数据</td></tr>';
        new bootstrap.Modal(document.getElementById('importMachinesModal')).show();
      });
      document.getElementById('processImportMachinesBtn').addEventListener('click', processImportMachinesFile);
      document.getElementById('importMachinesFile').addEventListener('change', previewImportMachines);
      document.getElementById('machinesTableBody').addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-machine') || e.target.closest('.delete-machine')) {
          const machineId = e.target.closest('.delete-machine').dataset.machineId;
          deleteMachine(machineId);
        }
      });
      document.getElementById('machineAreaFilter').addEventListener('change', filterMachinesTable);
      document.getElementById('machineSearchInput').addEventListener('input', updateMachineModalList);
      document.getElementById('closeMachineModalBtn').addEventListener('click', function() {
          bootstrap.Modal.getInstance(document.getElementById('machineSelectModal')).hide();
      });
      document.getElementById('machineSelectList').addEventListener('click', function(e) {
          const item = e.target.closest('.machine-modal-item');
          if (item) {
              const machineId = item.dataset.machineId;
              selectMachine(machineId);
              bootstrap.Modal.getInstance(document.getElementById('machineSelectModal')).hide();
          }
      });
    }
    // ... (此处省略大量未修改的UI交互函数，如 confirmWorker, addNewWorker, filterSummaryData 等，它们保持原样)
    
    // --- 为了篇幅，以下是其余所有函数的代码，它们的功能和之前保持一致 ---
    function clearFilters() { document.getElementById('summaryWorkerId').value = ''; document.getElementById('summaryWorkArea').value = ''; document.getElementById('summaryOperationType').value = ''; document.getElementById('summaryDateFrom').value = ''; document.getElementById('summaryDateTo').value = ''; filterSummaryData(); }
    function previewExcel() { const fileInput = document.getElementById('excelFile'); const file = fileInput.files[0]; const statusEl = document.getElementById('uploadStatus'); const previewTable = document.getElementById('excelPreview').querySelector('tbody'); if (!file) { statusEl.innerHTML = '<div class="alert alert-danger">请选择Excel文件</div>'; return; } const reader = new FileReader(); reader.onload = function(e) { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' }); if (jsonData.length === 0) { previewTable.innerHTML = '<tr><td colspan="3" class="text-center">Excel文件中没有数据</td></tr>'; return; } const requiredFields = ['坯布编号', '原料编号', '原料名称']; const header = jsonData[0]; const hasRequiredFields = requiredFields.every(field => header.includes(field)); if (!hasRequiredFields) { previewTable.innerHTML = `<tr><td colspan="3" class="text-center">Excel文件格式不正确，需要包含列：${requiredFields.join(', ')}</td></tr>`; return; } let html = ''; for (let i = 1; i < Math.min(6, jsonData.length); i++) { const row = jsonData[i]; html += '<tr>'; html += `<td>${row[header.indexOf('坯布编号')] || ''}</td>`; html += `<td>${row[header.indexOf('原料编号')] || ''}</td>`; html += `<td>${row[header.indexOf('原料名称')] || ''}</td>`; html += '</tr>'; } if (jsonData.length > 6) { html += `<tr><td colspan="3" class="text-center">...只显示前5行，共${jsonData.length - 1}行数据</td></tr>`; } previewTable.innerHTML = html; statusEl.innerHTML = `<div class="alert alert-success">检测到 ${jsonData.length - 1} 条匹配记录</div>`; } catch (error) { console.error('预览Excel文件出错:', error); previewTable.innerHTML = '<tr><td colspan="3" class="text-center">处理文件时出错，请检查文件格式</td></tr>'; statusEl.innerHTML = '<div class="alert alert-danger">处理文件时出错，请检查文件格式</div>'; } }; reader.readAsArrayBuffer(file); }
    function confirmWorker() { const workerSelect = document.getElementById('workerSelect'); const workerId = workerSelect.value; const workArea = document.getElementById('workAreaSelect').value; if (!workerId) { showAlert('请选择员工', 'danger'); return; } if (!workArea) { showAlert('请选择作业区域', 'danger'); return; } const worker = workers.find(w => w.workerId === workerId); if (!worker) { showAlert('所选员工不存在', 'danger'); return; } document.getElementById('workerInfo').style.display = 'block'; document.getElementById('workerInfo').innerHTML = ` <strong>工号：</strong>${worker.workerId}<br> <strong>姓名：</strong>${worker.name}<br> <strong>作业区域：</strong>${workArea}<br> <span class="text-success">已确认，请填写报工信息</span> `; currentWorkerId = workerId; currentWorkArea = workArea; document.getElementById('currentWorkerId').textContent = worker.workerId; document.getElementById('currentWorkerName').textContent = worker.name; document.getElementById('currentWorkArea').textContent = workArea; reportTab.disabled = false; tabs.show(document.getElementById('report-tab')); }
    function addNewWorker() { const workerId = document.getElementById('newWorkerId').value.trim(); const name = document.getElementById('newWorkerName').value.trim(); if (!workerId || !name) { showAlert('请输入工号和姓名', 'danger'); return; } if (workers.some(w => w.workerId === workerId)) { showAlert(`工号 ${workerId} 已存在`, 'warning'); return; } const newWorker = { workerId, name }; workers.push(newWorker); localStorage.setItem('workers', JSON.stringify(workers)); document.getElementById('newWorkerId').value = ''; document.getElementById('newWorkerName').value = ''; updateWorkersTable(); updateWorkerSelect(); updateWorkerStats(); updateMemoryUsage(); showAlert(`成功添加员工：${name} (${workerId})`, 'success'); }
    function updateWorkerStats() { document.getElementById('totalWorkersCount').textContent = workers.length; const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30); const activeWorkers = new Set(); reports.forEach(report => { const reportDate = new Date(report.timestamp); if (reportDate > thirtyDaysAgo) { activeWorkers.add(report.workerId); } }); document.getElementById('activeWorkersCount').textContent = activeWorkers.size; const avgReports = workers.length > 0 ? (reports.length / workers.length).toFixed(1) : 0; document.getElementById('avgReports').textContent = avgReports; }
    function logout() { currentWorkerId = ''; currentWorkArea = ''; document.getElementById('workerInfo').style.display = 'none'; document.getElementById('reportForm').reset(); resetReportForm(); reportTab.disabled = true; tabs.show(document.getElementById('login-tab')); }
    function resetReportForm() { document.getElementById('reportForm').reset(); document.getElementById('productionDate').valueAsDate = new Date(); document.getElementById('matchResult').style.display = 'none'; document.getElementById('materialCode').value = ''; document.getElementById('materialName').value = ''; if (manualInputEnabled) { toggleManualInput(); } if (manualMachineInputEnabled) { toggleManualMachineInput(); } document.getElementById('machineId').value = ''; }
    function toggleManualInput() { const materialCodeInput = document.getElementById('materialCode'); const materialNameInput = document.getElementById('materialName'); const button = document.getElementById('toggleMaterialInputBtn'); manualInputEnabled = !manualInputEnabled; materialCodeInput.readOnly = !manualInputEnabled; materialNameInput.readOnly = !manualInputEnabled; if (manualInputEnabled) { button.innerHTML = '<i class="fas fa-times"></i>'; button.classList.remove('btn-outline-secondary'); button.classList.add('btn-warning'); document.getElementById('matchResult').innerHTML = ` <div class="alert alert-info"> <i class="fas fa-info-circle me-2"></i> 已启用手动输入模式，请直接输入原料编号和名称 </div> `; document.getElementById('matchResult').style.display = 'block'; } else { button.innerHTML = '<i class="fas fa-pencil-alt"></i>'; button.classList.remove('btn-warning'); button.classList.add('btn-outline-secondary'); document.getElementById('matchResult').style.display = 'none'; } }
    function toggleManualMachineInput() { const machineInput = document.getElementById('machineId'); const selectBtn = document.getElementById('selectMachineBtn'); const toggleBtn = document.getElementById('toggleMachineInputBtn'); manualMachineInputEnabled = !manualMachineInputEnabled; machineInput.readOnly = !manualMachineInputEnabled; selectBtn.disabled = manualMachineInputEnabled; if (manualMachineInputEnabled) { toggleBtn.innerHTML = '<i class="fas fa-list"></i>'; toggleBtn.title = '切换回选择列表'; machineInput.placeholder = "请输入设备编号"; } else { toggleBtn.innerHTML = '<i class="fas fa-keyboard"></i>'; toggleBtn.title = "切换手动输入"; machineInput.placeholder = "请输入或选择设备编号"; } }
    function handleMatch() { const greyClothId = document.getElementById('greyClothId').value.trim(); const matchResult = document.getElementById('matchResult'); matchResult.innerHTML = ''; if (!greyClothId || !materialMatches.length) { matchResult.style.display = 'none'; return; } const matches = materialMatches.filter(item => item['坯布编号']?.toString().includes(greyClothId)); if (matches.length === 0) { matchResult.style.display = 'block'; matchResult.innerHTML = ` <div class="alert alert-warning"> <p>未找到匹配的坯布编号</p> <button class="btn btn-sm btn-info mt-2" id="enableManualBtn"> <i class="fas fa-pencil-alt me-1"></i>手动输入原料信息 </button> </div> `; document.getElementById('enableManualBtn').addEventListener('click', () => { if (!manualInputEnabled) { toggleManualInput(); } }); return; } matchResult.style.display = 'block'; if (matches.length === 1) { const match = matches[0]; document.getElementById('materialCode').value = match['原料编号'] || ''; document.getElementById('materialName').value = match['原料名称'] || ''; matchResult.innerHTML = ` <div class="alert alert-success"> <p><strong>已匹配到原料信息：</strong></p> <p>坯布编号: ${match['坯布编号'] || ''}</p> <p>原料编号: ${match['原料编号'] || ''}</p> <p>原料名称: ${match['原料名称'] || ''}</p> <button class="btn btn-sm btn-outline-secondary mt-2" id="manualOverrideBtn"> <i class="fas fa-pencil-alt me-1"></i>手动修改原料信息 </button> </div> `; document.getElementById('manualOverrideBtn').addEventListener('click', () => { if (!manualInputEnabled) { toggleManualInput(); } }); } else { let tableHTML = ` <div class="alert alert-info">找到 ${matches.length} 条匹配记录，请选择</div> <table class="table table-bordered"> <tr> <th>选择</th> <th>坯布编号</th> <th>原料编号</th> <th>原料名称</th> </tr> `; matches.forEach((m, i) => { tableHTML += ` <tr> <td><button class="btn btn-sm btn-primary select-match" data-index="${i}">选择</button></td> <td>${m['坯布编号']}</td> <td>${m['原料编号']}</td> <td>${m['原料名称']}</td> </tr> `; }); tableHTML += ` <tr> <td colspan="4" class="text-center"> <button class="btn btn-sm btn-outline-info mt-2" id="manualInputOptionBtn"> <i class="fas fa-pencil-alt me-1"></i>手动输入原料信息 </button> </td> </tr> </table>`; matchResult.innerHTML = tableHTML; document.querySelectorAll('.select-match').forEach(btn => { btn.addEventListener('click', () => { const m = matches[btn.dataset.index]; document.getElementById('materialCode').value = m['原料编号'] || ''; document.getElementById('materialName').value = m['原料名称'] || ''; matchResult.innerHTML = ` <div class="alert alert-success"> <p><strong>已选择原料信息：</strong></p> <p>坯布编号: ${m['坯布编号'] || ''}</p> <p>原料编号: ${m['原料编号'] || ''}</p> <p>原料名称: ${m['原料名称'] || ''}</p> <button class="btn btn-sm btn-outline-secondary mt-2" id="manualOverrideBtn"> <i class="fas fa-pencil-alt me-1"></i>手动修改原料信息 </button> </div> `; document.getElementById('manualOverrideBtn').addEventListener('click', () => { if (!manualInputEnabled) { toggleManualInput(); } }); }); }); document.getElementById('manualInputOptionBtn').addEventListener('click', () => { if (!manualInputEnabled) { toggleManualInput(); } }); } }
    function handleGreyClothInput() { clearTimeout(debounceTimer); const inputValue = greyClothIdInput.value.trim(); greyClothSuggestions.innerHTML = ''; greyClothSuggestions.style.display = 'none'; if (inputValue.length < 2) { return; } debounceTimer = setTimeout(() => { const uniqueSuggestions = new Set(); materialMatches.forEach(item => { const clothNum = item['坯布编号']?.toString() || ''; if (clothNum.includes(inputValue)) { uniqueSuggestions.add(clothNum); } }); if (uniqueSuggestions.size === 0) { return; } let html = ''; uniqueSuggestions.forEach(suggestion => { const matchIndex = suggestion.indexOf(inputValue); if (matchIndex !== -1) { const before = suggestion.substring(0, matchIndex); const match = suggestion.substring(matchIndex, matchIndex + inputValue.length); const after = suggestion.substring(matchIndex + inputValue.length); html += `<a class="dropdown-item" href="#">${before}<span class="suggestion-highlight">${match}</span>${after}</a>`; } else { html += `<a class="dropdown-item" href="#">${suggestion}</a>`; } }); greyClothSuggestions.innerHTML = html; greyClothSuggestions.style.display = 'block'; greyClothSuggestions.querySelectorAll('.dropdown-item').forEach(item => { item.addEventListener('click', (e) => { e.preventDefault(); const text = item.textContent; greyClothIdInput.value = text; greyClothSuggestions.innerHTML = ''; greyClothSuggestions.style.display = 'none'; handleMatch(); }); }); }, 300); }
    function processExcelFile() { const fileInput = document.getElementById('excelFile'); const file = fileInput.files[0]; const statusEl = document.getElementById('uploadStatus'); if (!file) { statusEl.innerHTML = '<div class="alert alert-danger">请选择Excel文件</div>'; return; } const reader = new FileReader(); reader.onload = async function(e) { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' }); if (jsonData.length === 0) { statusEl.innerHTML = '<div class="alert alert-warning">Excel文件中没有数据</div>'; return; } const requiredFields = ['坯布编号', '原料编号', '原料名称']; const hasRequiredFields = requiredFields.every(field => Object.keys(jsonData[0]).includes(field)); if (!hasRequiredFields) { statusEl.innerHTML = '<div class="alert alert-danger">Excel文件格式不正确，需要包含列：坯布编号, 原料编号, 原料名称</div>'; return; } const processedData = jsonData.map(item => ({ '坯布编号': item['坯布编号'] || '', '原料编号': item['原料编号'] || '', '原料名称': item['原料名称'] || '' })); materialMatches = processedData; localStorage.setItem('materialMatches', JSON.stringify(processedData)); statusEl.innerHTML = '<div class="alert alert-success">原料匹配表更新成功</div>'; new bootstrap.Modal(document.getElementById('uploadModal')).hide(); updateMemoryUsage(); } catch (error) { console.error('处理Excel文件出错:', error); statusEl.innerHTML = '<div class="alert alert-danger">处理文件时出错，请检查文件格式</div>'; } }; reader.readAsArrayBuffer(file); }
    function filterSummaryData() { const workerId = document.getElementById('summaryWorkerId').value; const workArea = document.getElementById('summaryWorkArea').value; const operationType = document.getElementById('summaryOperationType').value; const dateFrom = document.getElementById('summaryDateFrom').value; const dateTo = document.getElementById('summaryDateTo').value; filteredReports = reports.filter(report => { const isWorkerMatch = workerId === '' || report.workerId === workerId; const isWorkAreaMatch = workArea === '' || report.workArea === workArea; const isOperationTypeMatch = operationType === '' || report.operationType === operationType; const isDateMatch = (dateFrom === '' || report.productionDate >= dateFrom) && (dateTo === '' || report.productionDate <= dateTo); return isWorkerMatch && isWorkAreaMatch && isOperationTypeMatch && isDateMatch; }); currentPage = 1; updateSummaryTable(); updateSummaryStats(); }
    async function exportToExcel() { const progressModal = new bootstrap.Modal(document.getElementById('exportProgressModal')); progressModal.show(); const progressBar = document.getElementById('exportProgressBar'); const progressText = document.getElementById('exportProgressText'); const statusEl = document.getElementById('exportStatus'); progressBar.style.width = '0%'; progressText.textContent = '0%'; statusEl.innerHTML = '<div class="alert alert-info">开始导出...</div>'; try { const wb = XLSX.utils.book_new(); const batchSize = 10000; const batchCount = Math.ceil(filteredReports.length / batchSize); if (filteredReports.length <= batchSize) { const ws = XLSX.utils.json_to_sheet(filteredReports); XLSX.utils.book_append_sheet(wb, ws, '报工数据'); progressBar.style.width = '100%'; progressText.textContent = '100%'; statusEl.innerHTML = '<div class="alert alert-success">正在生成Excel文件...</div>'; setTimeout(() => { XLSX.writeFile(wb, '报工数据.xlsx'); statusEl.innerHTML = '<div class="alert alert-success">导出成功！</div>'; }, 500); return; } statusEl.innerHTML = `<div class="alert alert-info">正在处理大量数据（${filteredReports.length}条），请稍候...</div>`; const processBatch = async (batchIndex) => { const start = batchIndex * batchSize; const end = Math.min(start + batchSize, filteredReports.length); const batchData = filteredReports.slice(start, end); const ws = XLSX.utils.json_to_sheet(batchData); const sheetName = `报工数据${batchIndex + 1}`; XLSX.utils.book_append_sheet(wb, ws, sheetName); const progress = Math.round(((batchIndex + 1) / batchCount) * 100); progressBar.style.width = `${progress}%`; progressText.textContent = `${progress}%`; if (batchIndex < batchCount - 1) { await new Promise(resolve => setTimeout(resolve, 0)); await processBatch(batchIndex + 1); } }; await processBatch(0); statusEl.innerHTML = '<div class="alert alert-success">正在生成Excel文件...</div>'; setTimeout(() => { XLSX.writeFile(wb, '报工数据.xlsx'); statusEl.innerHTML = '<div class="alert alert-success">导出成功！</div>'; }, 500); } catch (error) { console.error('导出Excel失败:', error); statusEl.innerHTML = `<div class="alert alert-danger">导出失败: ${error.message}</div>`; } }
    function updateWorkersTable() { const tableBody = document.getElementById('workersTableBody'); tableBody.innerHTML = ''; workers.forEach((worker, index) => { const row = document.createElement('tr'); const workerReports = reports.filter(report => report.workerId === worker.workerId); const reportCount = workerReports.length; let lastReportDate = '无记录'; if (reportCount > 0) { const dates = workerReports.map(r => new Date(r.timestamp).getTime()); const maxDate = new Date(Math.max(...dates)); lastReportDate = maxDate.toISOString().split('T')[0]; } row.innerHTML = ` <td>${index + 1}</td> <td>${worker.workerId}</td> <td>${worker.name}</td> <td>${reportCount}</td> <td>${lastReportDate}</td> <td> <button class="btn btn-sm btn-danger delete-worker" data-worker-id="${worker.workerId}"> <i class="fas fa-trash-alt"></i> 删除 </button> </td> `; tableBody.appendChild(row); }); if (workers.length === 0) { tableBody.innerHTML = '<tr><td colspan="6" class="text-center">暂无员工数据</td></tr>'; } }
    async function deleteWorker(workerId) { if (confirm('确定要删除该员工吗？报工数据将保留。')) { workers = workers.filter(w => w.workerId !== workerId); localStorage.setItem('workers', JSON.stringify(workers)); updateWorkersTable(); updateWorkerSelect(); updateWorkerStats(); updateSummaryStats(); updateMemoryUsage(); showAlert('员工已删除，报工数据保留', 'success'); } }
    function updateSummaryTable() { const tableBody = document.getElementById('summaryTableBody'); tableBody.innerHTML = ''; const totalRecords = filteredReports.length; const totalPages = Math.ceil(totalRecords / itemsPerPage); document.getElementById('totalRecords').textContent = totalRecords; document.getElementById('totalPages').textContent = totalPages; document.getElementById('currentPage').textContent = currentPage; document.getElementById('prevPageBtn').disabled = currentPage === 1; document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalPages === 0; if (totalRecords === 0) { tableBody.innerHTML = '<tr><td colspan="13" class="text-center">暂无数据</td></tr>'; return; } const startIndex = (currentPage - 1) * itemsPerPage; const endIndex = Math.min(startIndex + itemsPerPage, totalRecords); const currentPageData = filteredReports.slice(startIndex, endIndex); currentPageData.forEach((report, index) => { const row = document.createElement('tr'); const workerExists = workers.some(w => w.workerId === report.workerId); const globalIndex = startIndex + index + 1; if (!workerExists) { row.classList.add('deleted-worker'); } row.innerHTML = ` <td>${globalIndex}</td> <td>${report.workerId}</td> <td>${report.workerName}</td> <td>${report.workArea}</td> <td>${report.machineId}</td> <td>${report.greyClothId}</td> <td>${report.materialName}</td> <td>${report.operationType}</td> <td>${report.grainCount}</td> <td>${report.grainWeight}</td> <td>${report.totalWeight.toFixed(1)}</td> <td>${report.productionDate}</td> <td> <div class="action-buttons"> <button class="btn btn-sm btn-info edit-report" data-report-id="${report.reportId}"> <i class="fas fa-edit"></i> </button> <button class="btn btn-sm btn-danger delete-report" data-report-id="${report.reportId}"> <i class="fas fa-trash-alt"></i> </button> </div> </td> `; tableBody.appendChild(row); }); }
    function goToPrevPage() { if (currentPage > 1) { currentPage--; updateSummaryTable(); } }
    function goToNextPage() { const totalPages = Math.ceil(filteredReports.length / itemsPerPage); if (currentPage < totalPages) { currentPage++; updateSummaryTable(); } }
    function editReport(reportId) { const report = reports.find(r => r.reportId === reportId); if (!report) return; document.getElementById('editReportId').value = report.reportId; document.getElementById('editWorkerId').value = report.workerId; document.getElementById('editWorkerName').value = report.workerName; document.getElementById('editWorkArea').value = report.workArea; document.getElementById('editMachineId').value = report.machineId; document.getElementById('editGreyClothId').value = report.greyClothId; document.getElementById('editMaterialName').value = report.materialName; document.getElementById('editOperationType').value = report.operationType; document.getElementById('editGrainCount').value = report.grainCount; document.getElementById('editGrainWeight').value = report.grainWeight; document.getElementById('editProductionDate').value = report.productionDate; new bootstrap.Modal(document.getElementById('editReportModal')).show(); }
    async function saveReportChanges() { /*... 此处省略编辑逻辑，未来可添加后端支持 ...*/ showAlert('编辑功能待后端支持', 'info'); }
    async function deleteReport(reportId) { /*... 此处省略删除逻辑，未来可添加后端支持 ...*/ showAlert('删除功能待后端支持', 'info');}
    async function deleteByDate() { /*... 此处省略按日期删除逻辑，未来可添加后端支持 ...*/ showAlert('按日期删除功能待后端支持', 'info');}
    function updateSummaryStats() { const totalReports = reports.length; const totalGrains = reports.reduce((sum, report) => sum + report.grainCount, 0); const totalWorkers = new Set(reports.map(report => report.workerId)).size; const totalWeight = reports.reduce((sum, report) => sum + report.totalWeight, 0).toFixed(1); document.getElementById('totalReports').textContent = totalReports; document.getElementById('totalGrains').textContent = totalGrains; document.getElementById('totalWorkers').textContent = totalWorkers; document.getElementById('totalWeight').textContent = totalWeight; updateSummaryTable(); updateOperationTypeChart(); updateWorkerRankingChart(); const summaryWorkerId = document.getElementById('summaryWorkerId'); summaryWorkerId.innerHTML = '<option value="">全部工号</option>'; const uniqueWorkerIds = [...new Set(reports.map(report => report.workerId))]; uniqueWorkerIds.forEach(id => { const report = reports.find(r => r.workerId === id); const option = document.createElement('option'); option.value = id; option.textContent = `${id} - ${report ? report.workerName : '未知'}`; summaryWorkerId.appendChild(option); }); }
    function updateOperationTypeChart() { const operationTypeCounts = { '上纱': 0, '下纱': 0 }; reports.forEach(report => { if(operationTypeCounts[report.operationType] !== undefined) operationTypeCounts[report.operationType]++; }); const labels = Object.keys(operationTypeCounts); const data = Object.values(operationTypeCounts); if (typeChartInstance) { typeChartInstance.destroy(); } const ctx = document.getElementById('operationTypeChart').getContext('2d'); typeChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ data: data, backgroundColor: ['#2c6fbb', '#6c757d'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', }, tooltip: { callbacks: { label: function(context) { const label = context.label || ''; const value = context.raw || 0; const total = context.dataset.data.reduce((a, b) => a + b, 0); if (total === 0) return `${label}: 0 (0%)`; const percentage = Math.round((value / total) * 100); return `${label}: ${value} (${percentage}%)`; } } } } } }); }
    function updateWorkerRankingChart() { const workerReportCounts = {}; reports.forEach(report => { if (!workerReportCounts[report.workerId]) { workerReportCounts[report.workerId] = { name: report.workerName, count: 0 }; } workerReportCounts[report.workerId].count++; }); const sortedWorkers = Object.values(workerReportCounts).sort((a, b) => b.count - a.count).slice(0, 7); const labels = sortedWorkers.map(worker => worker.name); const data = sortedWorkers.map(worker => worker.count); if (rankingChartInstance) { rankingChartInstance.destroy(); } const ctx = document.getElementById('workerRankingChart').getContext('2d'); rankingChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: '报工次数', data: data, backgroundColor: '#2c6fbb', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: '报工次数' } }, x: { title: { display: true, text: '员工姓名' } } } } }); }
    async function clearAllData() { /*... 此处省略清空逻辑，未来可添加后端支持 ...*/ showAlert('清空功能待后端支持', 'info');}
    function exportAllData() { const wb = XLSX.utils.book_new(); const ws1 = XLSX.utils.json_to_sheet(workers); XLSX.utils.book_append_sheet(wb, ws1, '员工数据'); const ws2 = XLSX.utils.json_to_sheet(reports); XLSX.utils.book_append_sheet(wb, ws2, '报工记录'); const ws3 = XLSX.utils.json_to_sheet(materialMatches); XLSX.utils.book_append_sheet(wb, ws3, '原料匹配表'); const ws4 = XLSX.utils.json_to_sheet(machines); XLSX.utils.book_append_sheet(wb, ws4, '设备数据'); XLSX.writeFile(wb, '报工系统备份_' + new Date().toISOString().slice(0, 10) + '.xlsx'); showAlert('所有数据已导出', 'success'); }
    async function generateTestData() { /*... 省略测试数据生成逻辑 ...*/ showAlert('测试数据生成功能待后端支持', 'info');}
    function showAlert(message, type) { document.querySelectorAll('.alert-floating').forEach(el => el.remove()); const alertDiv = document.createElement('div'); alertDiv.classList.add('alert', `alert-${type}`, 'alert-floating'); alertDiv.innerHTML = ` <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'danger' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'} me-2"></i> ${message} `; document.body.appendChild(alertDiv); setTimeout(() => { alertDiv.remove(); }, 3000); }
    function addNewMachine() { /*... 省略设备管理逻辑 ...*/ }
    function deleteMachine(machineId) { /*... 省略设备管理逻辑 ...*/ }
    function updateMachinesTable() { /*... 省略设备管理逻辑 ...*/ }
    function filterMachinesTable() { /*... 省略设备管理逻辑 ...*/ }
    function updateMachineStats() { /*... 省略设备管理逻辑 ...*/ }
    async function deleteAllMachines() { /*... 省略设备管理逻辑 ...*/ }
    function previewImportMachines() { /*... 省略设备管理逻辑 ...*/ }
    function processImportMachinesFile() { /*... 省略设备管理逻辑 ...*/ }
    function openMachineSelectModal() { if (manualMachineInputEnabled) { showAlert('请先切换回选择列表模式', 'warning'); return; } if (!currentWorkArea) { showAlert('请先登录并选择作业区域', 'warning'); return; } document.getElementById('machineSearchInput').value = ''; updateMachineModalList(); new bootstrap.Modal(document.getElementById('machineSelectModal')).show(); }
    function updateMachineModalList() { const listElement = document.getElementById('machineSelectList'); const searchInput = document.getElementById('machineSearchInput').value.toLowerCase(); const countDisplay = document.getElementById('machineModalCount'); let filteredMachines = machines.filter(m => m.area === currentWorkArea); if (searchInput) { filteredMachines = filteredMachines.filter(m => m.machineId.toLowerCase().includes(searchInput) || (m.desc && m.desc.toLowerCase().includes(searchInput))); } countDisplay.textContent = filteredMachines.length; if (filteredMachines.length === 0) { listElement.innerHTML = '<div class="text-center text-muted">暂无匹配的设备</div>'; return; } filteredMachines.sort((a, b) => a.machineId.localeCompare(b.machineId)); let html = ''; const selectedMachineId = document.getElementById('machineId').value; filteredMachines.forEach(machine => { const isSelected = machine.machineId === selectedMachineId; const descText = machine.desc ? `<div class="machine-modal-desc">${machine.desc}</div>` : ''; html += ` <div class="machine-modal-item ${isSelected ? 'selected' : ''}" data-machine-id="${machine.machineId}"> <div class="machine-modal-id">${machine.machineId}</div> ${descText} </div> `; }); listElement.innerHTML = html; }
    function selectMachine(machineId) { document.getElementById('machineId').value = machineId; }

    // #################################################################
    // ###########        END: MODIFIED JAVASCRIPT           ###########
    // #################################################################
  </script>
</body>
</html>```