<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>纺织厂报工系统</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
  <style>
    /* 您的所有 CSS 样式代码都保持不变 */
    :root {
      --primary: #2c6fbb;
      --secondary: #6c757d;
      --light: #f8f9fa;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --info: #17a2b8;
    }
    body {
      background-color: #f5f7fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.08);
      padding: 20px;
    }
    .header {
      text-align: center;
      padding: 15px 0;
      margin-bottom: 25px;
      border-bottom: 1px solid #eaeaea;
      position: relative;
    }
    .header h3 {
      color: var(--primary);
      font-weight: 700;
      margin: 0;
    }
    .header::after {
      content: '';
      display: block;
      width: 80px;
      height: 4px;
      background: var(--primary);
      border-radius: 2px;
      position: absolute;
      bottom: -2px;
      left: 50%;
      transform: translateX(-50%);
    }
    .nav-tabs {
      border-bottom: 2px solid #eaeaea;
      margin-bottom: 20px;
    }
    .nav-tabs .nav-link {
      font-weight: 600;
      padding: 12px 25px;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s ease;
    }
    .nav-tabs .nav-link.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 8px rgba(44, 111, 187, 0.2);
    }
    .tab-content {
      padding: 25px;
      border: 1px solid #eaeaea;
      border-radius: 0 8px 8px 8px;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    .worker-info {
      margin-bottom: 15px;
      border-radius: 8px;
    }
    .stat-card {
      text-align: center;
      padding: 20px;
      border-radius: 12px;
      background: white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s;
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }
    .stat-card i {
      font-size: 2.5rem;
      margin-bottom: 15px;
      color: var(--primary);
    }
    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
    }
    .chart-container {
      height: 300px;
      margin-top: 20px;
    }
    .match-result {
      max-height: 300px;
      overflow-y: auto;
    }
    .login-card {
      max-width: 500px;
      margin: 0 auto;
    }
    .display-column {
      background-color: #fff8e1;
      font-weight: 600;
    }
    .deleted-worker {
      background-color: #fff8f0;
      color: #ff6b6b;
    }
    .deleted-worker td:last-child {
      color: #ff6b6b;
      font-style: italic;
    }
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    .action-buttons .btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
    }
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding: 10px 0;
      border-top: 1px solid #eee;
    }
    .page-info {
      font-size: 0.9rem;
      color: #666;
    }
    .pagination-buttons {
      display: flex;
      gap: 5px;
    }
    /* 模糊匹配样式 */
    .suggestion-highlight {
      color: var(--primary);
      font-weight: bold;
      background-color: rgba(44, 111, 187, 0.1);
    }
    /* 测试数据样式 */
    .test-data-card {
      border-left: 4px solid #6f42c1;
    }
    .test-data-progress {
      height: 10px;
    }
    .test-data-status {
      font-size: 0.9rem;
    }
    /* 员工管理卡片样式 */
    .worker-card {
      border-top: 3px solid var(--primary);
    }
    .worker-card-header {
      background-color: var(--primary);
      color: white;
      border-radius: 8px 8px 0 0 !important;
    }
    .worker-stat {
      background-color: #e8f4ff;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
      transition: transform 0.3s;
    }
    .worker-stat:hover {
      transform: scale(1.03);
    }
    .worker-stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary);
    }
    .worker-stat-label {
      font-size: 0.9rem;
      color: #6c757d;
    }
    /* 新增样式 */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1050;
    }
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }
    .btn-hover-grow {
      transition: transform 0.2s ease;
    }
    .btn-hover-grow:hover {
      transform: scale(1.05);
    }
    .input-group-text {
      background-color: #e9ecef;
      transition: background-color 0.3s;
    }
    .input-group:focus-within .input-group-text {
      background-color: #dde7f5;
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.2rem rgba(44, 111, 187, 0.25);
    }
    .alert-floating {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      min-width: 300px;
      opacity: 0.95;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: fadeIn 0.3s, fadeOut 0.5s 2.5s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 0.95; transform: translateY(0); }
    }
    @keyframes fadeOut {
      from { opacity: 0.95; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-20px); }
    }
    .card-header {
      font-weight: 600;
    }
    .table-hover tbody tr {
      transition: background-color 0.2s;
    }
    .table-hover tbody tr:hover {
      background-color: rgba(44, 111, 187, 0.05);
    }
    .badge-pill {
      padding: 0.5em 0.8em;
      border-radius: 10rem;
    }
    .progress-bar-striped {
      background-image: linear-gradient(
        45deg,
        rgba(255, 255, 255, 0.15) 25%,
        transparent 25%,
        transparent 50%,
        rgba(255, 255, 255, 0.15) 50%,
        rgba(255, 255, 255, 0.15) 75%,
        transparent 75%,
        transparent
      );
      background-size: 1rem 1rem;
    }
    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
    }
    .btn-primary:hover {
      background-color: #235a9e;
      border-color: #215397;
    }
    .btn-outline-primary {
      color: var(--primary);
      border-color: var(--primary);
    }
    .btn-outline-primary:hover {
      background-color: var(--primary);
      color: white;
    }
    .btn-success {
      background-color: var(--success);
      border-color: var(--success);
    }
    .btn-info {
      background-color: var(--info);
      border-color: var(--info);
    }
    .btn-warning {
      background-color: var(--warning);
      border-color: var(--warning);
      color: #212529;
    }
    .btn-danger {
      background-color: var(--danger);
      border-color: var(--danger);
    }
    .form-label {
      font-weight: 500;
    }
    .card {
      border: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .card:hover {
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }
    .nav-link {
      position: relative;
      overflow: hidden;
    }
    .nav-link::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background-color: var(--primary);
      transform: scaleX(0);
      transform-origin: right;
      transition: transform 0.3s ease;
    }
    .nav-link.active::after,
    .nav-link:hover::after {
      transform: scaleX(1);
      transform-origin: left;
    }
    .dropdown-menu {
      max-height: 300px;
      overflow-y: auto;
    }
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 15px;
      }
      .nav-tabs .nav-link {
        padding: 8px 15px;
        font-size: 0.9rem;
      }
      .tab-content {
        padding: 15px;
      }
      .pagination-container {
        flex-direction: column;
        gap: 10px;
      }
      .action-buttons {
        flex-direction: column;
        gap: 5px;
      }
      .row > * {
        margin-bottom: 15px;
      }
    }
    /* 设备管理模块样式 */
    .machine-card {
      border-top: 3px solid var(--primary);
    }
    .machine-card-header {
      background-color: var(--primary);
      color: white;
      border-radius: 8px 8px 0 0 !important;
    }
    .machine-stat {
      background-color: #e8f4ff;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
      transition: transform 0.3s;
    }
    .machine-stat:hover {
      transform: scale(1.03);
    }
    .machine-stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary);
    }
    .machine-stat-label {
      font-size: 0.9rem;
      color: #6c757d;
    }
    /* 设备选择弹窗样式 - 更新为网格布局 */

    .machine-search-container {
        position: relative;
        margin-bottom: 1rem;
    }
    .machine-search-container .form-control {
        padding-left: 2.5rem; /* 为图标留出空间 */
    }
    .machine-search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }
    .machine-modal-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
    }
    .machine-modal-count {
        font-size: 0.875rem;
        color: #6c757d;
    }
    .machine-modal-buttons {
        display: flex;
        gap: 0.5rem;
    }
    
    /* --- 1. 增大弹窗宽度以适应10列 --- */
/* 针对超大屏幕 (通常 >= 1200px) */
@media (min-width: 1200px) {
  /* 增大 modal-xl 的最大宽度 */
  .modal-xl {
    max-width: 98vw; /* 使用视口宽度的 98%，留一点边距 */
    margin-left: auto;
    margin-right: auto;
  }
}

/* 如果屏幕非常大，可以增加一个更大的断点 */
@media (min-width: 1400px) {
  .modal-xl {
    max-width: 99vw; /* 例如，在更大的屏幕上使用 99vw */
  }
}


/* --- 2. 调整设备列表网格为10列 --- */
.machine-modal-list {
  max-height: 400px; /* 可根据需要调整 */
  overflow-y: auto;
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
  padding: 0.5rem 2px 0.5rem 2px; /* top, right, bottom, left */
  display: grid;
  /* --- 关键修改点：设置为10列 --- */
  grid-template-columns: repeat(10, 1fr);
  /* 减小间距以节省空间 */
  gap: 4px; /* 可根据视觉效果微调 */
}

/* --- 3. 调整单个设备项样式以适应更窄的宽度 --- */
.machine-modal-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  /* 减小内边距 */
  padding: 6px 2px;
  text-align: center;
  /* 可以稍微减小字体大小 */
  font-size: 0.85rem;
  /* 保持最小高度一致 */
  min-height: 55px;
  /* 保持边框和圆角 */
  border: 1px solid #e9ecef;
  border-radius: 0.25rem;
  cursor: pointer;
  transition: all 0.2s ease;
  /* 防止内容溢出 */
  overflow: hidden;
}

.machine-modal-item:hover {
  background-color: #f0f8ff;
  border-color: var(--primary);
  transform: scale(1.02); /* 轻微放大效果 */
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.machine-modal-item.selected {
  background-color: #e8f4ff;
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(44, 111, 187, 0.25);
}

.machine-modal-id {
  font-weight: bold;
  color: var(--primary);
  /* 字体大小可以和 .machine-modal-item 保持一致或稍大一点 */
  font-size: 0.9rem;
  margin-bottom: 0.1rem;
  /* 防止编号过长溢出 */
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  width: 100%;
}

.machine-modal-desc {
  font-size: 0.75rem; /* 稍微减小描述字体 */
  color: #6c757d;
  margin-top: 0.1rem;
  text-align: center;
  /* 确保描述也限制在一行内并有省略号 */
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  width: 100%;
}

/* --- 4. （可选）优化搜索框 --- */
.machine-search-container .form-control {
  padding-left: 2.5rem; /* 为图标留出空间 */
}

/* --- 5. （可选）调整响应式断点 --- */
/* 确保在更小的屏幕上会自动调整列数 */
@media (max-width: 1200px) {
  .machine-modal-list {
    /* 例如，在中等屏幕下降到 8 列 */
    grid-template-columns: repeat(8, 1fr);
  }
}
@media (max-width: 992px) {
  .machine-modal-list {
    /* 平板每行 6 个 */
    grid-template-columns: repeat(6, 1fr);
  }
}
@media (max-width: 768px) {
  .machine-modal-list {
    /* 小屏幕每行 4 个 */
    grid-template-columns: repeat(4, 1fr);
  }
}
@media (max-width: 576px) {
  .machine-modal-list {
    /* 手机每行 2 个 */
    grid-template-columns: repeat(2, 1fr);
  }
}

/* --- 6. （临时）确保修改生效 --- */
/* 最好通过调整CSS顺序或特异性来避免使用 !important，
   但如果修改后未生效，可以临时使用 !important 测试。
   测试成功后，应移除 !important 并通过正确的CSS优先级管理样式。 */
/*
.machine-modal-list {
    grid-template-columns: repeat(10, 1fr) !important;
    gap: 4px !important;
    padding-left: 2px !important;
    padding-right: 2px !important;
}
*/
  </style>
</head>
<body>
  
  <!-- 您的所有 HTML 结构代码都保持不变 -->
  <div class="container">
    <div class="header">
      <h3><i class="fas fa-industry me-2"></i>纺织厂报工系统</h3>
    </div>
    <!-- 导航选项卡 -->
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login-pane" type="button" role="tab">
          <i class="fas fa-sign-in-alt me-2"></i>工号登录
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="report-tab" data-bs-toggle="tab" data-bs-target="#report-pane" type="button" role="tab" disabled>
          <i class="fas fa-edit me-2"></i>报工录入
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary-pane" type="button" role="tab">
          <i class="fas fa-list-alt me-2"></i>报工汇总
        </button>
      </li>
      <!-- 新增员工管理选项卡 -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="worker-tab" data-bs-toggle="tab" data-bs-target="#worker-pane" type="button" role="tab">
          <i class="fas fa-users me-2"></i>员工管理
        </button>
      </li>
      <!-- 新增设备管理选项卡 -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="machine-tab" data-bs-toggle="tab" data-bs-target="#machine-pane" type="button" role="tab">
          <i class="fas fa-cogs me-2"></i>设备管理
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-pane" type="button" role="tab">
          <i class="fas fa-cog me-2"></i>系统设置
        </button>
      </li>
    </ul>
    <!-- 选项卡内容 -->
    <div class="tab-content" id="mainTabsContent">
      <!-- 工号登录面板 -->
      <div class="tab-pane fade show active" id="login-pane" role="tabpanel">
        <div class="login-card card">
          <div class="card-header">选择工号登录</div>
          <div class="card-body">
            <div class="form-group mb-3">
              <label for="workerSelect" class="form-label">选择员工：</label>
              <select id="workerSelect" class="form-control">
                <option value="">-- 请选择员工 --</option>
              </select>
            </div>
            <!-- 新增作业区域选择 -->
            <div class="form-group mb-4">
              <label for="workAreaSelect" class="form-label">作业区域：</label>
              <select id="workAreaSelect" class="form-control">
                <option value="10车间">10车间</option>
                <option value="纬编百兴G1-4楼">纬编百兴G1-4楼</option>
                <option value="纬编百兴G1-5楼">纬编百兴G1-5楼</option>
                <option value="纬编百兴G2-1楼">纬编百兴G2-1楼</option>
                <option value="纬编百兴G2-2楼">纬编百兴G2-2楼</option>
                <option value="纬编百兴G2-4楼">纬编百兴G2-4楼</option>
                <option value="纬编百兴G2-5楼">纬编百兴G2-5楼</option>
              </select>
            </div>
            <div class="text-center">
              <button id="confirmWorkerBtn" class="btn btn-primary w-100 btn-hover-grow">
                <i class="fas fa-check-circle me-2"></i>确认登录
              </button>
            </div>
            <div id="workerInfo" class="mt-4 alert alert-info" style="display: none;"></div>
          </div>
        </div>
      </div>
      <!-- 报工录入面板 -->
      <div class="tab-pane fade" id="report-pane" role="tabpanel">
        <div class="worker-info alert alert-success d-flex justify-content-between align-items-center">
          <div>
            <strong>当前用户：</strong>
            <span id="currentWorkerName"></span>
            (<span id="currentWorkerId"></span>)
            <span class="ms-2 badge bg-primary badge-pill" id="currentWorkArea"></span>
          </div>
        </div>
        <div class="card">
          <div class="card-header">报工信息录入</div>
          <div class="card-body">
            <form id="reportForm">
              <div class="row mb-3">
                <div class="col-md-6">
    <div class="form-group">
        <label for="machineId">设备编号：</label>
        <div class="input-group">
            <input type="text" id="machineId" class="form-control" placeholder="请输入或选择设备编号" required>
            <button type="button" id="selectMachineBtn" class="btn btn-outline-primary" title="选择设备"><i class="fas fa-list"></i></button>
            <button type="button" id="toggleMachineInputBtn" class="btn btn-outline-secondary btn-hover-grow" title="切换手动输入"><i class="fas fa-keyboard"></i></button>
        </div>
        <div class="form-text">点击 <i class="fas fa-list"></i> 选择设备，或点击 <i class="fas fa-keyboard"></i> 手动输入</div>
    </div>
</div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="greyClothId">坯布编号：</label>
                    <input type="text" id="greyClothId" class="form-control" required>
                    <div id="greyClothSuggestions" class="dropdown-menu"></div>
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="materialCode">原料编号：</label>
                    <div class="input-group">
                      <input type="text" id="materialCode" class="form-control" readonly>
                      <button type="button" id="toggleMaterialInputBtn" class="btn btn-outline-secondary btn-hover-grow">
                        <i class="fas fa-pencil-alt"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="materialName">原料名称：</label>
                    <input type="text" id="materialName" class="form-control" readonly>
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="operationType">操作类型：</label>
                    <select id="operationType" class="form-control" required>
                      <option value="上纱" selected>上纱</option>
                      <option value="下纱">下纱</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="grainCount">粒数：</label>
                    <input type="number" id="grainCount" class="form-control" min="1" max="300" required>
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="grainWeight">粒重（KG）：</label>
                    <div class="input-group">
                      <input type="number" id="grainWeight" class="form-control" min="0" max="15" step="0.5" placeholder="请输入粒重" required>
                      <select class="form-select" id="grainWeightOptions" style="max-width: 150px;">
                        <option value="">常用值</option>
                        <option value="1">1</option>
                        <option value="1.5">1.5</option>
                        <option value="2">2</option>
                        <option value="2.5">2.5</option>
                        <option value="3">3</option>
                        <option value="3.5">3.5</option>
                        <option value="4">4</option>
                        <option value="4.5">4.5</option>
                        <option value="5">5</option>
                        <option value="5.5">5.5</option>
                        <option value="6">6</option>
                        <option value="6.5">6.5</option>
                        <option value="7">7</option>
                        <option value="7.5">7.5</option>
                        <option value="8">8</option>
                        <option value="8.5">8.5</option>
                        <option value="9">9</option>
                        <option value="9.5">9.5</option>
                        <option value="10">10</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="productionDate">生产日期：</label>
                    <input type="date" id="productionDate" class="form-control" required>
                  </div>
                </div>
              </div>
              <div class="form-group mb-4">
                <label for="remarks">备注：</label>
                <textarea id="remarks" class="form-control" rows="2"></textarea>
              </div>
              <div class="d-flex justify-content-between">
                <div>
                  <button type="submit" class="btn btn-primary me-2 btn-hover-grow">
                    <i class="fas fa-paper-plane me-2"></i>提交报工
                  </button>
                  <button type="button" id="resetReportBtn" class="btn btn-secondary me-2 btn-hover-grow">
                    <i class="fas fa-redo me-2"></i>重置
                  </button>
                </div>
              </div>
            </form>
            <div id="matchResult" class="match-result mt-4" style="display: none;"></div>
          </div>
        </div>
      </div>
      <!-- 报工汇总面板 -->
      <div class="tab-pane fade" id="summary-pane" role="tabpanel">
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="stat-card">
              <i class="fas fa-file-alt"></i>
              <div class="value" id="totalReports">0</div>
              <div class="label">总报工数</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <i class="fas fa-cubes"></i>
              <div class="value" id="totalGrains">0</div>
              <div class="label">总粒数</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <i class="fas fa-weight-hanging"></i>
              <div class="value" id="totalWeight">0</div>
              <div class="label">总重量(KG)</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <i class="fas fa-users"></i>
              <div class="value" id="totalWorkers">0</div>
              <div class="label">员工总数</div>
            </div>
          </div>
        </div>
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>报工数据筛选</span>
            <button id="exportExcelBtn" class="btn btn-success btn-sm btn-hover-grow">
              <i class="fas fa-file-excel me-2"></i>导出Excel
            </button>
          </div>
          <div class="card-body">
            <div class="row mb-4">
              <div class="col-md-3">
                <label for="summaryWorkerId">按工号筛选：</label>
                <select id="summaryWorkerId" class="form-control">
                  <option value="">全部工号</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="summaryWorkArea">作业区域：</label>
                <select id="summaryWorkArea" class="form-control">
                  <option value="">全部区域</option>
                  <option value="10车间">10车间</option>
                  <option value="纬编百兴G1-4楼">纬编百兴G1-4楼</option>
                  <option value="纬编百兴G1-5楼">纬编百兴G1-5楼</option>
                  <option value="纬编百兴G2-1楼">纬编百兴G2-1楼</option>
                  <option value="纬编百兴G2-2楼">纬编百兴G2-2楼</option>
                  <option value="纬编百兴G2-4楼">纬编百兴G2-4楼</option>
                  <option value="纬编百兴G2-5楼">纬编百兴G2-5楼</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="summaryDateFrom">开始日期：</label>
                <input type="date" id="summaryDateFrom" class="form-control">
              </div>
              <div class="col-md-3">
                <label for="summaryDateTo">结束日期：</label>
                <input type="date" id="summaryDateTo" class="form-control">
              </div>
            </div>
            <div class="row mb-4">
              <div class="col-md-3">
                <label for="summaryOperationType">操作类型：</label>
                <select id="summaryOperationType" class="form-control">
                  <option value="">全部类型</option>
                  <option value="上纱">上纱</option>
                  <option value="下纱">下纱</option>
                </select>
              </div>
              <div class="col-md-3">
                <label>&nbsp;</label>
                <button id="filterSummaryBtn" class="btn btn-primary w-100 btn-hover-grow">
                  <i class="fas fa-filter me-2"></i>筛选
                </button>
              </div>
              <div class="col-md-6">
                <label>&nbsp;</label>
                <button id="clearFilterBtn" class="btn btn-outline-secondary w-100 btn-hover-grow">
                  <i class="fas fa-times-circle me-2"></i>清除筛选
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-bordered table-hover">
                <thead class="table-light">
                  <tr>
                    <th>序号</th>
                    <th>工号</th>
                    <th>姓名</th>
                    <th>作业区域</th>
                    <th>设备编号</th>
                    <th>坯布编号</th>
                    <th>原料名称</th>
                    <th>操作类型</th>
                    <th>粒数</th>
                    <th>粒重(KG)</th>
                    <th>总重量(KG)</th>
                    <th>日期</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="summaryTableBody">
                  <tr>
                    <td colspan="13" class="text-center">暂无数据</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <!-- 分页控件 -->
            <div class="pagination-container">
              <div class="page-info">
                共 <span id="totalRecords">0</span> 条记录，每页 30 条
              </div>
              <div class="pagination-buttons">
                <button id="prevPageBtn" class="btn btn-sm btn-outline-primary" disabled>
                  <i class="fas fa-chevron-left me-1"></i>上一页
                </button>
                <span class="mx-2">
                  第 <span id="currentPage">1</span> 页 / 共 <span id="totalPages">1</span> 页
                </span>
                <button id="nextPageBtn" class="btn btn-sm btn-outline-primary" disabled>
                  下一页<i class="fas fa-chevron-right ms-1"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">报工类型分布</div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="operationTypeChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">员工报工量排名</div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="workerRankingChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- 新增员工管理面板 -->
      <div class="tab-pane fade" id="worker-pane" role="tabpanel">
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="worker-stat">
              <div class="worker-stat-value" id="totalWorkersCount">0</div>
              <div class="worker-stat-label">员工总数</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="worker-stat">
              <div class="worker-stat-value" id="activeWorkersCount">0</div>
              <div class="worker-stat-label">活跃员工</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="worker-stat">
              <div class="worker-stat-value" id="avgReports">0</div>
              <div class="worker-stat-label">人均报工数</div>
            </div>
          </div>
        </div>
        <div class="card worker-card mb-4">
          <div class="card-header worker-card-header">
            <i class="fas fa-user-plus me-2"></i>添加新员工
          </div>
          <div class="card-body">
            <div class="worker-form">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group mb-3">
                    <label for="newWorkerId" class="form-label">工号：</label>
                    <input type="text" id="newWorkerId" class="form-control" placeholder="输入新工号">
                    <div class="form-text">工号必须是唯一的数字标识</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group mb-3">
                    <label for="newWorkerName" class="form-label">姓名：</label>
                    <input type="text" id="newWorkerName" class="form-control" placeholder="输入姓名">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12">
                  <div class="d-grid">
                    <button id="addWorkerBtn" class="btn btn-primary btn-hover-grow">
                      <i class="fas fa-user-plus me-2"></i>添加员工
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card worker-card">
          <div class="card-header worker-card-header">
            <i class="fas fa-users me-2"></i>员工列表管理
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-bordered table-hover">
                <thead class="table-light">
                  <tr>
                    <th>序号</th>
                    <th>工号</th>
                    <th>姓名</th>
                    <th>报工次数</th>
                    <th>最近报工日期</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="workersTableBody">
                  <tr>
                    <td colspan="6" class="text-center">暂无员工数据</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
       <!-- 新增设备管理面板 -->
       <div class="tab-pane fade" id="machine-pane" role="tabpanel">
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="machine-stat">
              <div class="machine-stat-value" id="totalMachinesCount">0</div>
              <div class="machine-stat-label">设备总数</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="machine-stat">
              <div class="machine-stat-value" id="totalAreasCount">0</div>
              <div class="machine-stat-label">作业区域数</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="machine-stat">
              <div class="machine-stat-value" id="avgMachinesPerArea">0</div>
              <div class="machine-stat-label">平均每区域设备数</div>
            </div>
          </div>
        </div>
<!-- 新增：全部删除按钮区域 -->
<div class="row mb-3">
  <div class="col-md-12">
    <!-- 全部删除按钮 -->
    <button id="deleteAllMachinesBtn" class="btn btn-danger btn-sm" title="删除所有设备">
      <i class="fas fa-trash-alt me-1"></i>全部删除
    </button>
    <!-- 如果您希望按钮靠右对齐，可以使用下面的代码替换上面的 button 标签：
    <div class="text-end">
      <button id="deleteAllMachinesBtn" class="btn btn-danger btn-sm" title="删除所有设备">
        <i class="fas fa-trash-alt me-1"></i>全部删除
      </button>
    </div>
    -->
  </div>
</div>
<!-- /新增：全部删除按钮区域 -->
        <div class="card machine-card mb-4">
          <div class="card-header machine-card-header d-flex justify-content-between align-items-center">
            <span><i class="fas fa-cog me-2"></i>添加新设备</span>
            <button id="importMachinesBtn" class="btn btn-sm btn-light">
              <i class="fas fa-file-import me-2"></i>批量导入
            </button>
          </div>
          <div class="card-body">
            <div class="machine-form">
              <div class="row">
                <div class="col-md-4">
                  <div class="form-group mb-3">
                    <label for="newMachineArea" class="form-label">作业区域：</label>
                    <select id="newMachineArea" class="form-control">
                      <option value="10车间">10车间</option>
                      <option value="纬编百兴G1-4楼">纬编百兴G1-4楼</option>
                      <option value="纬编百兴G1-5楼">纬编百兴G1-5楼</option>
                      <option value="纬编百兴G2-1楼">纬编百兴G2-1楼</option>
                      <option value="纬编百兴G2-2楼">纬编百兴G2-2楼</option>
                      <option value="纬编百兴G2-4楼">纬编百兴G2-4楼</option>
                      <option value="纬编百兴G2-5楼">纬编百兴G2-5楼</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group mb-3">
                    <label for="newMachineId" class="form-label">设备编号：</label>
                    <input type="text" id="newMachineId" class="form-control" placeholder="输入设备编号 (例如: W001)">
                    <div class="form-text">编号必须唯一</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group mb-3">
                    <label for="newMachineDesc" class="form-label">设备描述：</label>
                    <input type="text" id="newMachineDesc" class="form-control" placeholder="输入设备描述 (可选)">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12">
                  <div class="d-grid">
                    <button id="addMachineBtn" class="btn btn-primary btn-hover-grow">
                      <i class="fas fa-plus-circle me-2"></i>添加设备
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card machine-card">
          <div class="card-header machine-card-header">
            <i class="fas fa-list me-2"></i>设备列表管理
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="machineAreaFilter" class="form-label">按作业区域筛选：</label>
              <select id="machineAreaFilter" class="form-control">
                <option value="">全部区域</option>
                <option value="10车间">10车间</option>
                <option value="纬编百兴G1-4楼">纬编百兴G1-4楼</option>
                <option value="纬编百兴G1-5楼">纬编百兴G1-5楼</option>
                <option value="纬编百兴G2-1楼">纬编百兴G2-1楼</option>
                <option value="纬编百兴G2-2楼">纬编百兴G2-2楼</option>
                <option value="纬编百兴G2-4楼">纬编百兴G2-4楼</option>
                <option value="纬编百兴G2-5楼">纬编百兴G2-5楼</option>
              </select>
            </div>
            <div class="table-responsive">
              <table class="table table-bordered table-hover">
                <thead class="table-light">
                  <tr>
                    <th>序号</th>
                    <th>作业区域</th>
                    <th>设备编号</th>
                    <th>设备描述</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="machinesTableBody">
                  <tr>
                    <td colspan="5" class="text-center">暂无设备数据</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <!-- 系统设置面板 -->
      <div class="tab-pane fade" id="settings-pane" role="tabpanel">
        <div class="card mb-4">
          <div class="card-header">数据管理</div>
          <div class="card-body">
            <div class="alert alert-info mb-4">
              <i class="fas fa-info-circle me-2"></i>
              为防止数据溢出，请定期清理旧数据或导出备份
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="card mb-3">
                  <div class="card-body">
                    <h5 class="card-title">按日期删除数据</h5>
                    <div class="mb-3">
                      <label for="deleteDateFrom" class="form-label">开始日期：</label>
                      <input type="date" id="deleteDateFrom" class="form-control">
                    </div>
                    <div class="mb-3">
                      <label for="deleteDateTo" class="form-label">结束日期：</label>
                      <input type="date" id="deleteDateTo" class="form-control">
                    </div>
                    <button id="deleteByDateBtn" class="btn btn-danger w-100 btn-hover-grow">
                      <i class="fas fa-trash-alt me-2"></i>删除选定日期数据
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">备份与恢复</h5>
                    <button id="exportAllDataBtn" class="btn btn-success w-100 mb-3 btn-hover-grow">
                      <i class="fas fa-download me-2"></i>导出所有数据
                    </button>
                    <button id="clearAllDataBtn" class="btn btn-danger w-100 btn-hover-grow">
                      <i class="fas fa-trash-alt me-2"></i>清空所有数据
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- 新增测试数据生成功能 -->
        <div class="card mb-4 test-data-card">
          <div class="card-header">系统压力测试</div>
          <div class="card-body">
            <div class="alert alert-warning mb-4">
              <i class="fas fa-exclamation-triangle me-2"></i>
              此功能用于测试系统最大报工量，生成的数据为模拟数据
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group mb-3">
                  <label for="testDataCount" class="form-label">生成记录数量：</label>
                  <input type="number" id="testDataCount" class="form-control" min="100" max="100000" value="1000">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group mb-3">
                  <label for="testDataDateRange" class="form-label">日期范围：</label>
                  <select id="testDataDateRange" class="form-control">
                    <option value="30">最近30天</option>
                    <option value="90">最近90天</option>
                    <option value="180">最近180天</option>
                    <option value="365">最近1年</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <div class="d-flex justify-content-between mb-1">
                <span>测试数据生成进度：</span>
                <span id="testProgressText">0%</span>
              </div>
              <div class="progress test-data-progress">
                <div id="testDataProgress" class="progress-bar bg-success progress-bar-striped" role="progressbar" style="width: 0%"></div>
              </div>
            </div>
            <div class="text-center">
              <button id="generateTestDataBtn" class="btn btn-info w-100 btn-hover-grow">
                <i class="fas fa-bolt me-2"></i>生成测试数据
              </button>
            </div>
            <div id="testDataStatus" class="mt-3 test-data-status"></div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">系统信息</div>
          <div class="card-body">
            <div class="mb-3">
              <div class="d-flex justify-content-between">
                <span>本地存储使用情况：</span>
                <span id="storageUsage">0 KB / 0 KB</span>
              </div>
              <div class="progress mt-2" style="height: 10px;">
                <div id="storageProgress" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%"></div>
              </div>
            </div>
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              当存储使用超过80%时，建议清理旧数据或导出备份
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- 加载指示器 -->
  <div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">加载中...</span>
    </div>
  </div>
  <!-- 原料匹配表上传模态框 -->
  <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadModalLabel">上传原料匹配表</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="excelFile" class="form-label">选择Excel文件：</label>
            <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls">
          </div>
          <div id="uploadStatus" class="mb-3"></div>
          <div class="table-responsive">
            <table class="table table-bordered mt-3" id="excelPreview">
              <thead>
                <tr>
                  <th>坯布编号</th>
                  <th>原料编号</th>
                  <th>原料名称</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="3" class="text-center">上传Excel文件后预览数据</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
          <button type="button" id="processExcelBtn" class="btn btn-primary">处理文件</button>
        </div>
      </div>
    </div>
  </div>
  <!-- 编辑报工记录模态框 -->
  <div class="modal fade" id="editReportModal" tabindex="-1" aria-labelledby="editReportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editReportModalLabel">编辑报工记录</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editReportForm">
            <input type="hidden" id="editReportId">
            <div class="mb-3">
              <label for="editWorkerId" class="form-label">工号</label>
              <input type="text" id="editWorkerId" class="form-control" readonly>
            </div>
            <div class="mb-3">
              <label for="editWorkerName" class="form-label">姓名</label>
              <input type="text" id="editWorkerName" class="form-control" readonly>
            </div>
            <div class="mb-3">
              <label for="editWorkArea" class="form-label">作业区域</label>
              <input type="text" id="editWorkArea" class="form-control" readonly>
            </div>
            <div class="mb-3">
              <label for="editMachineId" class="form-label">设备编号</label>
              <input type="text" id="editMachineId" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="editGreyClothId" class="form-label">坯布编号</label>
              <input type="text" id="editGreyClothId" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="editMaterialName" class="form-label">原料名称</label>
              <input type="text" id="editMaterialName" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="editOperationType" class="form-label">操作类型</label>
              <select id="editOperationType" class="form-control" required>
                <option value="上纱">上纱</option>
                <option value="下纱">下纱</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editGrainCount" class="form-label">粒数</label>
              <input type="number" id="editGrainCount" class="form-control" min="1" max="300" required>
            </div>
            <div class="mb-3">
              <label for="editGrainWeight" class="form-label">粒重(KG)</label>
              <div class="input-group">
                <input type="number" id="editGrainWeight" class="form-control" min="0" max="15" step="0.5" required>
                <select class="form-select" id="editGrainWeightOptions" style="max-width: 150px;">
                  <option value="">常用值</option>
                  <option value="1">1</option>
                  <option value="1.5">1.5</option>
                  <option value="2">2</option>
                  <option value="2.5">2.5</option>
                  <option value="3">3</option>
                  <option value="3.5">3.5</option>
                  <option value="4">4</option>
                  <option value="4.5">4.5</option>
                  <option value="5">5</option>
                  <option value="5.5">5.5</option>
                  <option value="6">6</option>
                  <option value="6.5">6.5</option>
                  <option value="7">7</option>
                  <option value="7.5">7.5</option>
                  <option value="8">8</option>
                  <option value="8.5">8.5</option>
                  <option value="9">9</option>
                  <option value="9.5">9.5</option>
                  <option value="10">10</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label for="editProductionDate" class="form-label">生产日期</label>
              <input type="date" id="editProductionDate" class="form-control" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" id="saveReportBtn" class="btn btn-primary">保存修改</button>
        </div>
      </div>
    </div>
  </div>
  <!-- 导出进度模态框 -->
  <div class="modal fade" id="exportProgressModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">导出数据</h5>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span>导出进度：</span>
              <span id="exportProgressText">0%</span>
            </div>
            <div class="progress">
              <div id="exportProgressBar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%"></div>
            </div>
          </div>
          <div id="exportStatus" class="mt-2"></div>
        </div>
      </div>
    </div>
  </div>
   <!-- 设备批量导入模态框 -->
  <div class="modal fade" id="importMachinesModal" tabindex="-1" aria-labelledby="importMachinesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="importMachinesModalLabel">批量导入设备</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="importMachinesFile" class="form-label">选择Excel文件：</label>
            <input type="file" class="form-control" id="importMachinesFile" accept=".xlsx,.xls">
          </div>
          <div id="importMachinesStatus" class="mb-3"></div>
          <div class="table-responsive">
            <table class="table table-bordered mt-3" id="importMachinesPreview">
              <thead>
                <tr>
                  <th>作业区域</th>
                  <th>设备编号</th>
                  <th>设备描述</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="3" class="text-center">上传Excel文件后预览数据</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
          <button type="button" id="processImportMachinesBtn" class="btn btn-primary">导入设备</button>
        </div>
      </div>
    </div>
  </div>
  <!-- 设备选择弹窗 - 更新为网格布局 -->
  <div class="modal fade" id="machineSelectModal" tabindex="-1" aria-labelledby="machineSelectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl"> <!-- 使用更大的模态框以适应网格 -->
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="machineSelectModalLabel">选择设备</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="machine-search-container">
            <i class="fas fa-search machine-search-icon"></i>
            <input type="text" id="machineSearchInput" class="form-control" placeholder="搜索设备编号或描述...">
          </div>
          <div id="machineSelectList" class="machine-modal-list">
            <div class="text-center text-muted">暂无设备数据</div>
          </div>
          <div class="machine-modal-footer">
            <div class="machine-modal-count">
              共 <span id="machineModalCount">0</span> 台设备
            </div>
            <div class="machine-modal-buttons">
              <button type="button" id="closeMachineModalBtn" class="btn btn-secondary btn-sm">
                关闭
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // #################################################################
    // ###########       START: MODIFIED JAVASCRIPT          ###########
    // #################################################################

    // 全局变量
    let currentWorkerId = '';
    let currentWorkArea = '';
    let materialMatches = [];
    let filteredReports = [];
    let workers = []; 
    let reports = [];
    let machines = []; // 现在这个数据将从云端获取
    let typeChartInstance = null;
    let rankingChartInstance = null;
    let manualInputEnabled = false;
    let manualMachineInputEnabled = false;
    let debounceTimer = null;
    let currentPage = 1;
    const itemsPerPage = 30;
    
    // DOM元素
    const tabs = bootstrap.Tab.getOrCreateInstance(document.getElementById('mainTabs'));
    const reportTab = document.getElementById('report-tab');
    const greyClothIdInput = document.getElementById('greyClothId');
    const greyClothSuggestions = document.getElementById('greyClothSuggestions');
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    function showLoading() { loadingOverlay.style.display = 'flex'; }
    function hideLoading() { loadingOverlay.style.display = 'none'; }

    async function loadDataFromBackend() {
        try {
            const response = await fetch('/.netlify/functions/reports');
            if (!response.ok) throw new Error(`网络错误: ${response.statusText}`);
            reports = await response.json();
            filteredReports = [...reports];
            updateSummaryStats();
            updateWorkersTable(); 
            updateWorkerStats();
        } catch (error) {
            console.error('从后端加载数据失败:', error);
            showAlert('数据加载失败，请检查网络并刷新重试', 'danger');
        }
    }

    async function loadMatchesFromBackend() {
        try {
            const response = await fetch('/.netlify/functions/matches');
            if (!response.ok) throw new Error('网络响应错误');
            const matchesData = await response.json();
            materialMatches = matchesData.map(item => ({
                '坯布编号': item.grey_cloth_id,
                '原料编号': item.material_id,
                '原料名称': item.material_name
            }));
        } catch (error) {
            console.error('从后端加载匹配数据失败:', error);
            showAlert('纱线匹配表加载失败，请刷新重试', 'warning');
        }
    }

    // +++ 新增的函数 START +++
    async function loadMachinesFromBackend() {
        try {
            const response = await fetch('/.netlify/functions/machines');
            if (!response.ok) throw new Error('网络响应错误');
            machines = await response.json(); 
            updateMachinesTable();
            updateMachineStats();
        } catch (error) {
            console.error('从后端加载设备数据失败:', error);
            showAlert('设备列表加载失败，请刷新重试', 'warning');
        }
    }
    // +++ 新增的函数 END +++

    document.addEventListener('DOMContentLoaded', async () => {
        document.getElementById('productionDate').valueAsDate = new Date();
        try {
            showLoading();
            
            await Promise.all([
                loadDataFromBackend(),
                loadMatchesFromBackend(),
                loadMachinesFromBackend() // <-- 新增调用
            ]);
            
            // 员工数据暂时仍保留在localStorage
            const savedWorkers = localStorage.getItem('workers');
            if (savedWorkers) {
                workers = JSON.parse(savedWorkers);
            } else {
                 workers = [
                  { workerId: '2101001', name: '张三' },
                  { workerId: '2101002', name: '李四' },
                  { workerId: '2101003', name: '王五' }
                ];
            }
            updateWorkerSelect();
            
            // --- DELETED: 删除了设备管理的 localStorage 加载逻辑 ---

            initEventListeners();
            startMemoryMonitoring();
        } catch (error) {
            console.error('初始化失败:', error);
            showAlert('系统初始化失败，请刷新页面重试', 'danger');
        } finally {
            hideLoading();
        }
    });

    function startMemoryMonitoring() {
      updateMemoryUsage();
      setInterval(updateMemoryUsage, 5000);
    }
    
    function updateMemoryUsage() {
        // ... (此函数保持不变) ...
    }

    function updateWorkerSelect() {
        // ... (此函数保持不变) ...
    }

    async function handleSubmit(e) {
        // ... (此函数保持不变) ...
    }

    function initEventListeners() {
      document.getElementById('confirmWorkerBtn').addEventListener('click', confirmWorker);
      document.getElementById('reportForm').addEventListener('submit', handleSubmit);
      document.getElementById('resetReportBtn').addEventListener('click', resetReportForm);
      greyClothIdInput.addEventListener('input', handleGreyClothInput);
      
      // --- DELETED: 删除了 uploadExcelBtn 和 processExcelBtn 的监听器 ---

      document.getElementById('filterSummaryBtn').addEventListener('click', filterSummaryData);
      document.getElementById('clearFilterBtn').addEventListener('click', clearFilters);
      document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
      document.getElementById('addWorkerBtn').addEventListener('click', addNewWorker);
      document.getElementById('clearAllDataBtn').addEventListener('click', clearAllData);
      document.getElementById('saveReportBtn').addEventListener('click', saveReportChanges);
      document.getElementById('deleteByDateBtn').addEventListener('click', deleteByDate);
      document.getElementById('exportAllDataBtn').addEventListener('click', exportAllData);
      document.getElementById('toggleMaterialInputBtn').addEventListener('click', toggleManualInput);
      document.getElementById('toggleMachineInputBtn').addEventListener('click', toggleManualMachineInput);
      document.getElementById('selectMachineBtn').addEventListener('click', openMachineSelectModal);
      document.getElementById('grainWeightOptions').addEventListener('change', function() { if (this.value) document.getElementById('grainWeight').value = this.value; });
      document.getElementById('editGrainWeightOptions').addEventListener('change', function() { if (this.value) document.getElementById('editGrainWeight').value = this.value; });
      document.getElementById('summaryTableBody').addEventListener('click', (e) => {
        if (e.target.closest('.edit-report')) editReport(e.target.closest('.edit-report').dataset.reportId);
        if (e.target.closest('.delete-report')) deleteReport(e.target.closest('.delete-report').dataset.reportId);
      });
      document.getElementById('workersTableBody').addEventListener('click', (e) => {
        if (e.target.closest('.delete-worker')) deleteWorker(e.target.closest('.delete-worker').dataset.workerId);
      });
      document.getElementById('prevPageBtn').addEventListener('click', goToPrevPage);
      document.getElementById('nextPageBtn').addEventListener('click', goToNextPage);
      document.getElementById('generateTestDataBtn').addEventListener('click', generateTestData);
      document.getElementById('report-pane').addEventListener('show.bs.tab', () => { document.getElementById('productionDate').valueAsDate = new Date(); });
      document.getElementById('addMachineBtn').addEventListener('click', addNewMachine);
      
      // --- DELETED: 删除了 importMachinesBtn 和 processImportMachinesBtn 的监听器 ---
      
      document.getElementById('machinesTableBody').addEventListener('click', (e) => {
        if (e.target.closest('.delete-machine')) deleteMachine(e.target.closest('.delete-machine').dataset.machineId);
      });
      document.getElementById('machineAreaFilter').addEventListener('change', updateMachinesTable); // 筛选时直接更新表格
      document.getElementById('machineSearchInput').addEventListener('input', updateMachineModalList);
      document.getElementById('closeMachineModalBtn').addEventListener('click', () => bootstrap.Modal.getInstance(document.getElementById('machineSelectModal')).hide());
      
      // --- MODIFIED: 修正了 machineSelectList 的事件监听 ---
      document.getElementById('machineSelectList').addEventListener('click', function(e) {
          const item = e.target.closest('.machine-modal-item');
          if (item) {
              const machineIdFromData = item.dataset.machineId;
              selectMachine(machineIdFromData);
              bootstrap.Modal.getInstance(document.getElementById('machineSelectModal')).hide();
          }
      });
    }
    
    // ... (此处省略大量未修改的UI交互函数，如 confirmWorker, addNewWorker, filterSummaryData 等)
    // ... (它们的内部逻辑保持不变，因为我们只修改了数据的来源和去向)
    function clearFilters() { /* ... */ }
    function confirmWorker() { /* ... */ }
    function addNewWorker() { /* ... */ }
    function updateWorkerStats() { /* ... */ }
    function logout() { /* ... */ }
    function resetReportForm() { /* ... */ }
    function toggleManualInput() { /* ... */ }
    function toggleManualMachineInput() { /* ... */ }
    function handleMatch() { /* ... */ }
    function handleGreyClothInput() { /* ... */ }
    // --- DELETED: processExcelFile 函数已删除 ---
    // --- DELETED: previewExcel 函数已删除 ---
    function filterSummaryData() { /* ... */ }
    async function exportToExcel() { /* ... */ }
    function updateWorkersTable() { /* ... */ }
    async function deleteWorker(workerId) { /* ... */ }
    function updateSummaryTable() { /* ... */ }
    function goToPrevPage() { /* ... */ }
    function goToNextPage() { /* ... */ }
    function editReport(reportId) { /* ... */ }
    async function saveReportChanges() { showAlert('编辑功能待后端支持', 'info'); }
    async function deleteReport(reportId) { showAlert('删除功能待后端支持', 'info'); }
    async function deleteByDate() { showAlert('按日期删除功能待后端支持', 'info'); }
    function updateSummaryStats() { /* ... */ }
    function updateOperationTypeChart() { /* ... */ }
    function updateWorkerRankingChart() { /* ... */ }
    async function clearAllData() { showAlert('清空功能待后端支持', 'info'); }
    function exportAllData() { /* ... */ }
    async function generateTestData() { showAlert('测试数据生成功能待后端支持', 'info'); }
    function showAlert(message, type) { /* ... */ }

    // --- MODIFIED: 更新了 addNewMachine 和 deleteMachine ---
    async function addNewMachine() {
        const area = document.getElementById('newMachineArea').value;
        const machineId = document.getElementById('newMachineId').value.trim();
        const desc = document.getElementById('newMachineDesc').value.trim();
        if (!area || !machineId) {
            showAlert('作业区域和设备编号不能为空', 'danger');
            return;
        }
        const newMachine = { area: area, machine_id: machineId, desc: desc };
        try {
            showLoading();
            const response = await fetch('/.netlify/functions/machines', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newMachine)
            });
            if (!response.ok) {
                const errorData = await response.json();
                if (errorData.error && errorData.error.includes('duplicate key')) {
                    throw new Error(`设备编号 ${machineId} 已存在`);
                }
                throw new Error(errorData.error || '添加失败');
            }
            showAlert(`成功添加设备：${machineId}`, 'success');
            document.getElementById('newMachineId').value = '';
            document.getElementById('newMachineDesc').value = '';
            await loadMachinesFromBackend();
        } catch (error) {
            showAlert(`添加失败: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    async function deleteMachine(machineId) {
        if (!confirm(`确定要删除设备 ${machineId} 吗？`)) return;
        try {
            showLoading();
            const response = await fetch(`/.netlify/functions/machines?machine_id=${machineId}`, {
                method: 'DELETE'
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || '删除失败');
            }
            showAlert(`成功删除设备：${machineId}`, 'success');
            await loadMachinesFromBackend();
        } catch (error) {
            showAlert(`删除失败: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }
    
    // --- MODIFIED: 更新了 updateMachinesTable ---
    function updateMachinesTable() {
        const tableBody = document.getElementById('machinesTableBody');
        tableBody.innerHTML = '';
        const areaFilter = document.getElementById('machineAreaFilter').value;
        const filteredMachineList = machines.filter(m => areaFilter === '' || m.area === areaFilter);

        filteredMachineList.forEach((machine, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${machine.area}</td>
                <td>${machine.machine_id}</td>
                <td>${machine.desc || ''}</td>
                <td>
                    <button class="btn btn-sm btn-danger delete-machine" data-machine-id="${machine.machine_id}">
                        <i class="fas fa-trash-alt"></i> 删除
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });

        if (filteredMachineList.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center">暂无设备数据</td></tr>';
        }
    }

    function updateMachineStats() {
        document.getElementById('totalMachinesCount').textContent = machines.length;
        const uniqueAreas = new Set(machines.map(m => m.area));
        document.getElementById('totalAreasCount').textContent = uniqueAreas.size;
        const avg = uniqueAreas.size > 0 ? (machines.length / uniqueAreas.size).toFixed(1) : 0;
        document.getElementById('avgMachinesPerArea').textContent = avg;
    }
    
    // --- DELETED: 删除了 deleteAllMachines, previewImportMachines, processImportMachinesFile ---

    function openMachineSelectModal() {
        if (manualMachineInputEnabled) { showAlert('请先切换回选择列表模式', 'warning'); return; }
        if (!currentWorkArea) { showAlert('请先登录并选择作业区域', 'warning'); return; }
        document.getElementById('machineSearchInput').value = '';
// (大约在 1460 行左右)
function openMachineSelectModal() {
    if (manualMachineInputEnabled) { showAlert('请先切换回选择列表模式', 'warning'); return; }
    if (!currentWorkArea) { showAlert('请先登录并选择作业区域', 'warning'); return; }
    document.getElementById('machineSearchInput').value = '';

    // +++ 新增下面的日志 START +++
    console.log("--- 打开设备选择器 ---");
    console.log("当前登录的作业区域 (currentWorkArea):", `"${currentWorkArea}"`);
    console.log("从后端获取的完整设备列表 (machines):", machines);
    
    // 我们手动模拟一次过滤，看看结果
    const filteredForDebug = machines.filter(m => m.area === currentWorkArea);
    console.log("过滤后的设备列表 (filteredForDebug):", filteredForDebug);
    console.log(`找到了 ${filteredForDebug.length} 个匹配的设备。`);
    // +++ 新增上面的日志 END +++

    updateMachineModalList();
    new bootstrap.Modal(document.getElementById('machineSelectModal')).show();
}
        updateMachineModalList();
        new bootstrap.Modal(document.getElementById('machineSelectModal')).show();
    }
    
    // --- MODIFIED: 更新了 updateMachineModalList ---
    function updateMachineModalList() {
        const listElement = document.getElementById('machineSelectList');
        const searchInput = document.getElementById('machineSearchInput').value.toLowerCase();
        const countDisplay = document.getElementById('machineModalCount');
        let filteredMachines = machines.filter(m => m.area === currentWorkArea);
        if (searchInput) {
            filteredMachines = filteredMachines.filter(m => 
                m.machine_id.toLowerCase().includes(searchInput) || 
                (m.desc && m.desc.toLowerCase().includes(searchInput))
            );
        }
        countDisplay.textContent = filteredMachines.length;
        if (filteredMachines.length === 0) {
            listElement.innerHTML = '<div class="text-center text-muted">暂无匹配的设备</div>';
            return;
        }
        filteredMachines.sort((a, b) => a.machine_id.localeCompare(b.machine_id));
        let html = '';
        const selectedMachineId = document.getElementById('machineId').value;
        filteredMachines.forEach(machine => {
            const isSelected = machine.machine_id === selectedMachineId;
            const descText = machine.desc ? `<div class="machine-modal-desc">${machine.desc}</div>` : '';
            html += `
                <div class="machine-modal-item ${isSelected ? 'selected' : ''}" data-machine-id="${machine.machine_id}">
                    <div class="machine-modal-id">${machine.machine_id}</div>
                    ${descText}
                </div>
            `;
        });
        listElement.innerHTML = html;
    }

    // --- MODIFIED: 更新了 selectMachine ---
    function selectMachine(selectedMachineId) {
        document.getElementById('machineId').value = selectedMachineId;
    }

    // #################################################################
    // ###########        END: MODIFIED JAVASCRIPT           ###########
    // #################################################################
  </script>
</body>
</html>
